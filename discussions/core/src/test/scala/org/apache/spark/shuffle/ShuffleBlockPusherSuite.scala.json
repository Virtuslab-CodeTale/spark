[
  {
    "id" : "c88dcfbd-d16d-463d-929e-8384629a66c7",
    "prId" : 30312,
    "prUrl" : "https://github.com/apache/spark/pull/30312#pullrequestreview-538721965",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "945a7ec3-09cb-489c-8589-8d71a8bb0447",
        "parentId" : null,
        "authorId" : "171fe41b-96df-4362-a600-2d1f030de577",
        "body" : "Maybe, also add the assertion for `unreachableBlockMgrs`?",
        "createdAt" : "2020-11-25T08:33:07Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "171fe41b-96df-4362-a600-2d1f030de577",
        "tags" : [
        ]
      },
      {
        "id" : "eba275bb-6964-4eb2-9107-bcfcca2764bb",
        "parentId" : "945a7ec3-09cb-489c-8589-8d71a8bb0447",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "Done. I had to make `unreachableBlockMgrs` visible for testing.",
        "createdAt" : "2020-11-25T17:34:50Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      }
    ],
    "commit" : "21ea881f398a35038e2359ef0b4ed5cd15aab736",
    "line" : 325,
    "diffHunk" : "@@ -1,1 +323,327 @@      .pushBlocks(any(), any(), any(), any(), any())\n    // 2 blocks for each merger locations\n    assert(pushedBlocks.length == 4)\n    assert(pusher.unreachableBlockMgrs.size == 2)\n  }"
  },
  {
    "id" : "046305ea-2d6e-4b62-adb4-2a32a08739a4",
    "prId" : 30312,
    "prUrl" : "https://github.com/apache/spark/pull/30312#pullrequestreview-542976804",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "0d24d7aa-60d0-4152-b291-5b612d383d76",
        "parentId" : null,
        "authorId" : "171fe41b-96df-4362-a600-2d1f030de577",
        "body" : "Could you add a test to cover the block retry process? (Not only test whether the error is retriable)",
        "createdAt" : "2020-11-25T08:35:47Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "171fe41b-96df-4362-a600-2d1f030de577",
        "tags" : [
        ]
      },
      {
        "id" : "112f00d1-a8c9-4846-99da-ca2f7e0763b7",
        "parentId" : "0d24d7aa-60d0-4152-b291-5b612d383d76",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "When a block fails to get pushed, the `RetryingBlockFetcher` tries to push it again. The exception for a particular block is propagated to ShuffleBlockPusher only when all the retries have failed. The tests for retry of a block push is covered in `OneForOneBlockPusherSuite`.\r\nI will add a test here that will verify that blocks are continued to push even when a single block push fails with collision exception.",
        "createdAt" : "2020-12-01T05:50:44Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "de0591e1-2955-40ac-86ef-12cb7bbd0128",
        "parentId" : "0d24d7aa-60d0-4152-b291-5b612d383d76",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "I have added the tests for these:\r\n- blocks are continued to push when collision exception is received.\r\n- blocks are stopped from being pushed when too late exception is received.",
        "createdAt" : "2020-12-01T07:27:23Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "13f6372b-c60a-4369-b3ed-03790a6d7fec",
        "parentId" : "0d24d7aa-60d0-4152-b291-5b612d383d76",
        "authorId" : "171fe41b-96df-4362-a600-2d1f030de577",
        "body" : "Thanks for the update. I haven't got a chunk of time to do the review recently. I still need to take another look. It's almost looks good to me. ",
        "createdAt" : "2020-12-02T15:51:13Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "171fe41b-96df-4362-a600-2d1f030de577",
        "tags" : [
        ]
      }
    ],
    "commit" : "21ea881f398a35038e2359ef0b4ed5cd15aab736",
    "line" : 220,
    "diffHunk" : "@@ -1,1 +218,222 @@  }\n\n  test(\"Error retries\") {\n    val pusher = new ShuffleBlockPusher(conf)\n    val errorHandler = pusher.createErrorHandler()"
  },
  {
    "id" : "614fd1c7-df20-40aa-93e9-4fe2005672c0",
    "prId" : 30312,
    "prUrl" : "https://github.com/apache/spark/pull/30312#pullrequestreview-541546548",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "460171a9-0288-43b5-a38c-39e8425bf977",
        "parentId" : null,
        "authorId" : "171fe41b-96df-4362-a600-2d1f030de577",
        "body" : "Could you also add tests for `prepareBlockPushRequests()`? So we can test the generated requests directly in addition to the verify the invocation number of `pushBlocks()`.",
        "createdAt" : "2020-11-25T08:38:31Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "171fe41b-96df-4362-a600-2d1f030de577",
        "tags" : [
        ]
      },
      {
        "id" : "0ec9e80b-2595-45fe-ab28-bff0a2ef2570",
        "parentId" : "460171a9-0288-43b5-a38c-39e8425bf977",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "`prepareBlockPushRequests` is covered by these tests:\r\n- `Large blocks are skipped for push`\r\n- `Number of blocks in flight per address are limited by maxBlocksInFlightPerAddress`\r\n- `Number of shuffle blocks grouped in a single push request is limited by maxBlockBatchSize`\r\nAre you suggesting to expose for `prepareBlockPushRequests` and `PushRequest` for testing and verify those requests?",
        "createdAt" : "2020-11-25T17:05:15Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "13229997-ffac-45e4-a38b-ecfbd08111ac",
        "parentId" : "460171a9-0288-43b5-a38c-39e8425bf977",
        "authorId" : "171fe41b-96df-4362-a600-2d1f030de577",
        "body" : "> Are you suggesting to expose for prepareBlockPushRequests and PushRequest for testing and verify those requests?\r\n\r\nYes. Those tests you mentioned above do test the expected behavior but at a higher level. We can test it directly by exposing `prepareBlockPushRequests`.",
        "createdAt" : "2020-11-30T07:10:12Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "171fe41b-96df-4362-a600-2d1f030de577",
        "tags" : [
        ]
      },
      {
        "id" : "bc2a85f1-4c3b-44e4-abe1-7ff3a0fe366a",
        "parentId" : "460171a9-0288-43b5-a38c-39e8425bf977",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "done",
        "createdAt" : "2020-12-01T07:25:25Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      }
    ],
    "commit" : "21ea881f398a35038e2359ef0b4ed5cd15aab736",
    "line" : 135,
    "diffHunk" : "@@ -1,1 +133,137 @@    blockPusher.runPendingTasks()\n    verify(shuffleClient, times(1))\n      .pushBlocks(any(), any(), any(), any(), any())\n    assert(pushedBlocks.length == dependency.partitioner.numPartitions)\n    ShuffleBlockPusher.stop()"
  },
  {
    "id" : "fca48ac2-3fa8-4ea7-8d9d-e0dfad1c0abc",
    "prId" : 30312,
    "prUrl" : "https://github.com/apache/spark/pull/30312#pullrequestreview-544190544",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "6f3b23cb-4dc9-4597-9b33-451778a2f6f9",
        "parentId" : null,
        "authorId" : "171fe41b-96df-4362-a600-2d1f030de577",
        "body" : "I thought the times of `pushBlocks` should be 9 and pushedBlocks.length should be 8. But I realize that the `retry` actually happens in `RetryingBlockFetcher` and we can not verify it here. So we actually don't verify the block is retried, right? Since we already have `OneForOneBlockPusherSuite` as you mentioned, it should be fine.\r\n\r\n\r\n\r\n",
        "createdAt" : "2020-12-03T07:43:03Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "171fe41b-96df-4362-a600-2d1f030de577",
        "tags" : [
        ]
      },
      {
        "id" : "11088a7a-71c0-41ce-9b07-d31abcb6cf07",
        "parentId" : "6f3b23cb-4dc9-4597-9b33-451778a2f6f9",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "Yes, here we don't verify the block is retried. These tests will only verify that more blocks will be pushed or not after this exception reaches `ShuffleBlockPusher`.",
        "createdAt" : "2020-12-03T17:12:46Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      }
    ],
    "commit" : "21ea881f398a35038e2359ef0b4ed5cd15aab736",
    "line" : 272,
    "diffHunk" : "@@ -1,1 +270,274 @@    verify(shuffleClient, times(8))\n      .pushBlocks(any(), any(), any(), any(), any())\n    assert(pushedBlocks.length == 7)\n  }\n"
  },
  {
    "id" : "6a614982-017b-44a1-a63f-8b37057d49b5",
    "prId" : 30312,
    "prUrl" : "https://github.com/apache/spark/pull/30312#pullrequestreview-545164909",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "04db1b84-1ff2-47e3-adb7-f8b92f1e2d29",
        "parentId" : null,
        "authorId" : "171fe41b-96df-4362-a600-2d1f030de577",
        "body" : "Could you add a comment like \"this ensures `updateStateAndCheckIfPushMore` and `pushUpToMax` are called synchronously\"?",
        "createdAt" : "2020-12-04T08:11:06Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "171fe41b-96df-4362-a600-2d1f030de577",
        "tags" : [
        ]
      },
      {
        "id" : "f567035a-4605-4762-b64f-984d99b741e4",
        "parentId" : "04db1b84-1ff2-47e3-adb7-f8b92f1e2d29",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "done",
        "createdAt" : "2020-12-04T17:39:51Z",
        "updatedAt" : "2020-12-19T04:21:15Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      }
    ],
    "commit" : "21ea881f398a35038e2359ef0b4ed5cd15aab736",
    "line" : 336,
    "diffHunk" : "@@ -1,1 +334,338 @@    }\n\n    def runPendingTasks(): Unit = {\n      // This ensures that all the submitted tasks - updateStateAndCheckIfPushMore and pushUpToMax\n      // are run synchronously."
  }
]