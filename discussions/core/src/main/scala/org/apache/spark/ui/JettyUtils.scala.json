[
  {
    "id" : "ebc403a3-a1fa-421e-a25b-081996cebf84",
    "prId" : 30552,
    "prUrl" : "https://github.com/apache/spark/pull/30552#pullrequestreview-541987898",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "fb973356-f7b0-4502-8585-7a3ccbcd0cfb",
        "parentId" : null,
        "authorId" : "707cf6e1-750c-4aea-8774-f79c13fb7add",
        "body" : "toString() is unnecesary here BTW.\r\nSo this relies on query already being escaped. That may be fine for the logic of this code, although in another world it would have been better to let this method take unescaped query strings and manage it here.",
        "createdAt" : "2020-12-01T14:42:40Z",
        "updatedAt" : "2020-12-01T14:42:41Z",
        "lastEditedBy" : "707cf6e1-750c-4aea-8774-f79c13fb7add",
        "tags" : [
        ]
      },
      {
        "id" : "d829c104-3922-4be4-93d0-f6049deee700",
        "parentId" : "fb973356-f7b0-4502-8585-7a3ccbcd0cfb",
        "authorId" : "15acce7d-132b-48c9-894b-9bc3f4c2b09d",
        "body" : "Thanks for the suggestion, Sean.\r\n> toString() is unnecesary here BTW.\r\n\r\n`uri` is `StringBuilder` here. The original code also use toString().\r\n\r\n> So this relies on query already being escaped. That may be fine for the logic of this code, although in another world it would have been better to let this method take unescaped query strings and manage it here.\r\n\r\nThe query string here should be encoded already.  I am not very familiar with this topic. Is there any better solution to handle both escaped/unescaped query string?",
        "createdAt" : "2020-12-01T14:56:45Z",
        "updatedAt" : "2020-12-01T14:56:45Z",
        "lastEditedBy" : "15acce7d-132b-48c9-894b-9bc3f4c2b09d",
        "tags" : [
        ]
      },
      {
        "id" : "fcff36e7-a1b9-4aff-a29b-bd84cdd2f305",
        "parentId" : "fb973356-f7b0-4502-8585-7a3ccbcd0cfb",
        "authorId" : "707cf6e1-750c-4aea-8774-f79c13fb7add",
        "body" : "Oh right, OK, ignore the toString() comment.\r\nI just mean that semantically, encoding is a URI detail. The program should probably not worry about it except when going to and from URIs. But that's not how this code is structured. It clearly already expects and escaped string as argument, which then means callers have to deal with it. But, I don't think it's necessary to change. If it is escaped then yes this is a fix.",
        "createdAt" : "2020-12-01T15:01:32Z",
        "updatedAt" : "2020-12-01T15:01:32Z",
        "lastEditedBy" : "707cf6e1-750c-4aea-8774-f79c13fb7add",
        "tags" : [
        ]
      }
    ],
    "commit" : "b34c0a5f1d18581ab71d38ac023a79fcc7378583",
    "line" : 20,
    "diffHunk" : "@@ -1,1 +408,412 @@    }\n    // SPARK-33611: use method `URI.create` to avoid percent-encoding twice on the query string.\n    URI.create(uri.toString() + queryString).normalize()\n  }\n"
  },
  {
    "id" : "1c256c4b-16e4-40a7-b5f8-2428b65ec279",
    "prId" : 29271,
    "prUrl" : "https://github.com/apache/spark/pull/29271#pullrequestreview-459355688",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "9b1c4381-96ed-442c-bffe-5d562dcc4c71",
        "parentId" : null,
        "authorId" : "2d6b46ba-4100-4c4d-9341-fff5e39647ec",
        "body" : "Can we try to use the same approach in `createProxyURI`? Looks like we can try to create a method to share in  `createRedirectURI` and `createProxyURI`.\r\n```\r\n    val rewrittenURI = URI.create(uri.toString())\r\n    if (query != null) {\r\n      return new URI(\r\n          rewrittenURI.getScheme(),\r\n          rewrittenURI.getAuthority(),\r\n          rewrittenURI.getPath(),\r\n          query,\r\n          rewrittenURI.getFragment()\r\n        ).normalize()\r\n    }\r\n```",
        "createdAt" : "2020-07-30T18:29:26Z",
        "updatedAt" : "2020-07-31T08:38:11Z",
        "lastEditedBy" : "2d6b46ba-4100-4c4d-9341-fff5e39647ec",
        "tags" : [
        ]
      },
      {
        "id" : "9da7ea0c-734a-4596-8e8a-03de1b5e017c",
        "parentId" : "9b1c4381-96ed-442c-bffe-5d562dcc4c71",
        "authorId" : "15acce7d-132b-48c9-894b-9bc3f4c2b09d",
        "body" : "I tried but it doesn't do the decoding with URI.toString\r\n```\r\nscala> new URI(\"https://g.com/ctx%281%29?a%5B0%5D=b\").normalize().toString\r\nres28: String = https://g.com/ctx%281%29?a%5B0%5D=b\r\n```",
        "createdAt" : "2020-07-31T08:35:20Z",
        "updatedAt" : "2020-07-31T08:38:11Z",
        "lastEditedBy" : "15acce7d-132b-48c9-894b-9bc3f4c2b09d",
        "tags" : [
        ]
      },
      {
        "id" : "eefd9316-48e1-480e-bd56-9f4bc4eebf4a",
        "parentId" : "9b1c4381-96ed-442c-bffe-5d562dcc4c71",
        "authorId" : "15acce7d-132b-48c9-894b-9bc3f4c2b09d",
        "body" : "We can build a URI and call get `getPath` and `getQuery`, and then build a new URI string from the decode result. ```\r\nscala> new URI(\"https://g.com/ctx%281%29?a%5B0%5D=b\").getPath\r\nres31: String = /ctx(1)\r\n\r\nscala> new URI(\"https://g.com/ctx%281%29?a%5B0%5D=b\").getQuery\r\nres33: String = a[0]=b\r\n```\r\nBut it seems equivalent of the current code.",
        "createdAt" : "2020-07-31T08:37:32Z",
        "updatedAt" : "2020-07-31T08:38:11Z",
        "lastEditedBy" : "15acce7d-132b-48c9-894b-9bc3f4c2b09d",
        "tags" : [
        ]
      },
      {
        "id" : "a9eff167-506d-4d0e-af49-17d3aa7e9fb1",
        "parentId" : "9b1c4381-96ed-442c-bffe-5d562dcc4c71",
        "authorId" : "2d6b46ba-4100-4c4d-9341-fff5e39647ec",
        "body" : "> I tried but it doesn't do the decoding with URI.toString\r\n\r\nURI.toString doesn't do the decoding. It will encode characters if necessary. For example,\r\n\r\n```\r\nscala> val uri = new java.net.URI(null, null, \"foo bar\", \"foo bar\", null).toString\r\nuri: String = foo%20bar?foo%20bar\r\n```\r\n\r\nAnyway, this doesn't matter. I tried to consolidate these two method but it didn't look better.",
        "createdAt" : "2020-07-31T17:52:48Z",
        "updatedAt" : "2020-07-31T17:52:53Z",
        "lastEditedBy" : "2d6b46ba-4100-4c4d-9341-fff5e39647ec",
        "tags" : [
        ]
      }
    ],
    "commit" : "ef6cb87d6b786fba8a56f92b7caf3d191eb6ab09",
    "line" : 43,
    "diffHunk" : "@@ -1,1 +457,461 @@    }\n    val authority = s\"$redirectServer:$port\"\n    val queryEncoding = if (request.getQueryEncoding != null) {\n      request.getQueryEncoding\n    } else {"
  }
]