[
  {
    "id" : "716cacdd-a45e-4923-be6c-5391a12ddbd9",
    "prId" : 33378,
    "prUrl" : "https://github.com/apache/spark/pull/33378#pullrequestreview-707953267",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "a79e2be9-66ba-4661-8fe2-f291e2959baa",
        "parentId" : null,
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "super nit: Make it `blockManager.blockManagerId.host` ?\r\nBoth have the same value, but it makes it clear what we are talking to.\r\n",
        "createdAt" : "2021-07-16T01:59:14Z",
        "updatedAt" : "2021-07-16T01:59:22Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "4489f526-fe27-486b-ad9c-eb7c3a4e6864",
        "parentId" : "a79e2be9-66ba-4661-8fe2-f291e2959baa",
        "authorId" : "171fe41b-96df-4362-a600-2d1f030de577",
        "body" : "+1",
        "createdAt" : "2021-07-16T02:20:59Z",
        "updatedAt" : "2021-07-16T02:20:59Z",
        "lastEditedBy" : "171fe41b-96df-4362-a600-2d1f030de577",
        "tags" : [
        ]
      }
    ],
    "commit" : "b7ae49bc6e3c229951c8ec2e9e114e82fd8161da",
    "line" : 24,
    "diffHunk" : "@@ -1,1 +204,208 @@        s\"dirs from the external shuffle service\")\n      hostLocalDirManager.getHostLocalDirs(blockManager.blockManagerId.host,\n        blockManager.externalShuffleServicePort, Array(SHUFFLE_MERGER_IDENTIFIER)) {\n        case Success(dirs) =>\n          logDebug(s\"Fetched merged dirs in \" +"
  },
  {
    "id" : "7bbcbd6a-cf9e-48f0-9e7c-3ac23146bccc",
    "prId" : 32140,
    "prUrl" : "https://github.com/apache/spark/pull/32140#pullrequestreview-682103663",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "94289049-d2f6-483b-8ef3-03c6757212ad",
        "parentId" : null,
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "Can we have NPE here ?",
        "createdAt" : "2021-06-10T15:04:24Z",
        "updatedAt" : "2021-06-10T17:58:42Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "cf34b69d-b808-45d1-870b-57a30299cdf2",
        "parentId" : "94289049-d2f6-483b-8ef3-03c6757212ad",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "`chunkBitmap` should not be `null`. I think the code is missing that assertion currently which I will add.",
        "createdAt" : "2021-06-10T19:34:34Z",
        "updatedAt" : "2021-06-10T19:34:35Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "9a5c8f49-862a-439f-b06e-24b42ec5c1e4",
        "parentId" : "94289049-d2f6-483b-8ef3-03c6757212ad",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "Added the assertion.",
        "createdAt" : "2021-06-11T00:12:44Z",
        "updatedAt" : "2021-06-11T00:12:44Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "f3d1316d-42d8-46d8-aa63-4c02958f8631",
        "parentId" : "94289049-d2f6-483b-8ef3-03c6757212ad",
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "If we are sure it cant be `null`, replace `orNull` with `get` instead ? It makes the semantics clearer.\r\nI am fine with leaving it with `assert` check as well.",
        "createdAt" : "2021-06-11T05:08:29Z",
        "updatedAt" : "2021-06-11T05:08:42Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "70f53c9a-a9c8-4b8a-9af4-156b0e19b109",
        "parentId" : "94289049-d2f6-483b-8ef3-03c6757212ad",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "I have changed this to ConcurrentHashMap and using `get`. Have also kept the assert check.",
        "createdAt" : "2021-06-11T06:24:02Z",
        "updatedAt" : "2021-06-11T06:24:02Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "64ce46d0-8e1c-41a8-9f39-5bfc4db37477",
        "parentId" : "94289049-d2f6-483b-8ef3-03c6757212ad",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "Resolving this one.",
        "createdAt" : "2021-06-11T18:10:48Z",
        "updatedAt" : "2021-06-11T18:10:49Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      }
    ],
    "commit" : "ad89a0208a5e3f880fca502c297362388a104dd7",
    "line" : 309,
    "diffHunk" : "@@ -1,1 +307,311 @@              logInfo(s\"Falling back immediately for shuffle chunk $pendingBlockId\")\n              val bitmapOfPendingChunk: RoaringBitmap = chunksMetaMap.remove(pendingBlockId).get\n              chunkBitmap.or(bitmapOfPendingChunk)\n            }\n            // These blocks were added to numBlocksToFetch so we increment numBlocksProcessed"
  },
  {
    "id" : "1582b83f-0518-4996-9e32-b2bc7a6951ad",
    "prId" : 32140,
    "prUrl" : "https://github.com/apache/spark/pull/32140#pullrequestreview-689613081",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "acb4dbf4-e95b-47f2-9b9d-4fc4cbb8c240",
        "parentId" : null,
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "There can be concurrent mods to this Map, handle MT-safety ?",
        "createdAt" : "2021-06-10T15:38:31Z",
        "updatedAt" : "2021-06-10T17:58:42Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "62debd48-49d6-41be-9eaf-c46f6654946e",
        "parentId" : "acb4dbf4-e95b-47f2-9b9d-4fc4cbb8c240",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "Same as above. It is always accessed by the task thread.",
        "createdAt" : "2021-06-10T19:46:10Z",
        "updatedAt" : "2021-06-10T19:46:11Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "b9d9786a-f5c9-4cef-b4f4-70de5269b972",
        "parentId" : "acb4dbf4-e95b-47f2-9b9d-4fc4cbb8c240",
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "`fetchMergedLocalBlock` is not invoked from the task thread right (from `fetchMergedLocalBlocks`) ?\r\nThat updates `chunksMetaMap` ?",
        "createdAt" : "2021-06-11T05:15:06Z",
        "updatedAt" : "2021-06-11T05:15:07Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "9934488c-d661-495b-8e6b-bf9a07292c41",
        "parentId" : "acb4dbf4-e95b-47f2-9b9d-4fc4cbb8c240",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "@mridulm That's a very good catch. Sorry, missed that. Netty thread will be adding to it for the local block. I will work on fixing this.",
        "createdAt" : "2021-06-11T05:38:49Z",
        "updatedAt" : "2021-06-11T05:38:49Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "cd200cc0-c176-4300-bcc6-307866f18076",
        "parentId" : "acb4dbf4-e95b-47f2-9b9d-4fc4cbb8c240",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "I have changed this to a `ConcurrentHashMap` and switched the order of these lines in `fetchMergedLocalBlock`\r\n```\r\n        chunksMetaMap.put(shuffleChunkId, chunksMeta(chunkId))\r\n        iterator.addToResultsQueue(\r\n          SuccessFetchResult(shuffleChunkId, SHUFFLE_PUSH_MAP_ID, blockManagerId, buf.size(), buf,\r\n            isNetworkReqDone = false))\r\n```\r\nI think this should solve any issues because all we want is the guarantee that while processing a `SuccessFetchResult` related to a shuffleChunkId, the meta for that shuffleChunkId is present in `chunksMetaMap`. \r\nI will think a bit more about this tomorrow. ",
        "createdAt" : "2021-06-11T06:09:13Z",
        "updatedAt" : "2021-06-11T06:26:19Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "db9e0ad6-f6e9-4f4b-8479-b96a2d6022be",
        "parentId" : "acb4dbf4-e95b-47f2-9b9d-4fc4cbb8c240",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "I took another look at it and I think making it a `ConcurrentMap` and swapping the order of those lines fix any issues related to multiple thread. PTAL.",
        "createdAt" : "2021-06-11T18:10:27Z",
        "updatedAt" : "2021-06-11T18:10:27Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      },
      {
        "id" : "7869312b-bd06-4bd1-873f-c83b7b9eb550",
        "parentId" : "acb4dbf4-e95b-47f2-9b9d-4fc4cbb8c240",
        "authorId" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "body" : "@mridulm In the new changes, I have moved the part in `fetchMergedLocalBlock` which was modifying the map to be handled just by the task thread when it processes `PushMergedLocalMetaFetchResult`. So, I have changed this map back to a regular hashmap because now it just gets modified by task thread. PTAL",
        "createdAt" : "2021-06-22T14:49:39Z",
        "updatedAt" : "2021-06-22T14:49:40Z",
        "lastEditedBy" : "9953a478-bdd8-4f15-be59-f6f654ff85ae",
        "tags" : [
        ]
      }
    ],
    "commit" : "ad89a0208a5e3f880fca502c297362388a104dd7",
    "line" : 57,
    "diffHunk" : "@@ -1,1 +55,59 @@   * A map for storing shuffle chunk bitmap.\n   */\n  private[this] val chunksMetaMap = new mutable.HashMap[ShuffleBlockChunkId, RoaringBitmap]()\n\n  /**"
  },
  {
    "id" : "4bc343c6-a7d8-41a2-a726-8717ab2a7de4",
    "prId" : 32140,
    "prUrl" : "https://github.com/apache/spark/pull/32140#pullrequestreview-690092850",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "7c296de4-fbfb-4a76-9011-a43219e03ac0",
        "parentId" : null,
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "Add a `get` method instead of creating a copy of `executorIdToLocalDirsCache` ?\r\nSomething like this in `HostLocalDirManager`:\r\n```\r\n  private[spark] def getCachedHostLocalDirs(executorId: String): Option[Array[String]] =\r\n    executorIdToLocalDirsCache.synchronized {\r\n      Option(executorIdToLocalDirsCache.getIfPresent(executorId))\r\n    }\r\n```",
        "createdAt" : "2021-06-23T00:40:31Z",
        "updatedAt" : "2021-06-23T01:27:16Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      }
    ],
    "commit" : "ad89a0208a5e3f880fca502c297362388a104dd7",
    "line" : 191,
    "diffHunk" : "@@ -1,1 +189,193 @@      pushMergedLocalBlocks: mutable.LinkedHashSet[BlockId]): Unit = {\n    val cachedPushedMergedDirs = hostLocalDirManager.getCachedHostLocalDirsFor(\n      SHUFFLE_MERGER_IDENTIFIER)\n    if (cachedPushedMergedDirs.isDefined) {\n      logDebug(s\"Fetch the push-merged-local blocks with cached merged dirs: \" +"
  }
]