[
  {
    "id" : "c7a92e09-7f59-4563-bee5-3f3c21db63d3",
    "prId" : 30763,
    "prUrl" : "https://github.com/apache/spark/pull/30763#pullrequestreview-555735738",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "9e1c25b7-dd65-4dde-9a9d-f6f048bcdba6",
        "parentId" : null,
        "authorId" : "ae55b635-dd0e-41aa-9272-372de9a35f38",
        "body" : "Should we add an annotation to the interface to match?",
        "createdAt" : "2020-12-18T18:55:34Z",
        "updatedAt" : "2021-03-08T08:42:24Z",
        "lastEditedBy" : "ae55b635-dd0e-41aa-9272-372de9a35f38",
        "tags" : [
        ]
      }
    ],
    "commit" : "8e54b41702fd3f8f78d14a57eeb3cf9277b666cc",
    "line" : 23,
    "diffHunk" : "@@ -1,1 +21,25 @@\n/**\n * :: Private ::\n *\n * A plugin that can monitor the storage of shuffle data from map tasks, and can provide"
  },
  {
    "id" : "239877da-2f0d-4620-b675-8149e9d8ddf1",
    "prId" : 28618,
    "prUrl" : "https://github.com/apache/spark/pull/28618#pullrequestreview-487317362",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "78de4109-54de-4b67-8c06-e8cb477c6380",
        "parentId" : null,
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "A callback to signal completion (or failure) of shuffle for a `shuffleId` will help `ShuffleDriverComponents` coordinate with external services to commit (or cleanup) shuffle metadata/files.",
        "createdAt" : "2020-08-20T05:11:54Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "6756ab3a-20a0-47dc-b575-65e54c8cc892",
        "parentId" : "78de4109-54de-4b67-8c06-e8cb477c6380",
        "authorId" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "body" : "I'm hesitant to make significant API changes given how late this is in the review stage - let's add it as a follow-up if there are concrete use cases that require it down the road.",
        "createdAt" : "2020-09-10T00:30:28Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "tags" : [
        ]
      },
      {
        "id" : "4a29a449-baa8-40dc-9333-88889b9c8548",
        "parentId" : "78de4109-54de-4b67-8c06-e8cb477c6380",
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "Looking at the currently designed api, this is a missing gap.",
        "createdAt" : "2020-09-10T06:07:40Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "1f24868e-d1e7-41d0-9e20-051463e590c0",
        "parentId" : "78de4109-54de-4b67-8c06-e8cb477c6380",
        "authorId" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "body" : "Again - I don't want to add it here, since it would require further integration of such a new API call in the rest of the Spark codebase, which I am holding as out of scope for this patch.",
        "createdAt" : "2020-09-10T16:44:19Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "tags" : [
        ]
      },
      {
        "id" : "a34e0514-de88-44ab-b2d7-ce4aefbca574",
        "parentId" : "78de4109-54de-4b67-8c06-e8cb477c6380",
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "This is as a gap in the proposed api - which limits the effectiveness to leverage it for other shuffle usecases.\r\n+CC @otterc PTAL if without this, shuffle changes can be made for your patches.\r\nAlternative would be to do this in subsequent or other efforts to complete the api.",
        "createdAt" : "2020-09-12T15:47:08Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "c6be8240-d977-4da3-a0e9-b7c680e6cd1d",
        "parentId" : "78de4109-54de-4b67-8c06-e8cb477c6380",
        "authorId" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "body" : "This API isn't complete as of this patch anyways, so I'd prefer that functionality to be deferred since the complexity being added here is already pretty significant. Can we file a follow up JIRA for it and go from there?",
        "createdAt" : "2020-09-13T15:36:01Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "tags" : [
        ]
      }
    ],
    "commit" : "f69cba7d0632e7b260e38a0aa16cf560bd0d94cc",
    "line" : 43,
    "diffHunk" : "@@ -1,1 +41,45 @@   */\n  void registerShuffle(int shuffleId);\n\n  /**\n   * Called when the shuffle with the given id is unregistered because it will no longer"
  },
  {
    "id" : "d0fbf02c-cae3-4899-8a5b-36bbce1cbac1",
    "prId" : 28618,
    "prUrl" : "https://github.com/apache/spark/pull/28618#pullrequestreview-487970092",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "6bd9786c-9b5f-4fe8-af2a-4e300584d2c8",
        "parentId" : null,
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "Add a note about what locking semantics are when the methods are invoked ?",
        "createdAt" : "2020-08-20T05:33:13Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "c5162a6d-6442-4867-89ee-ed2038f6c121",
        "parentId" : "6bd9786c-9b5f-4fe8-af2a-4e300584d2c8",
        "authorId" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "body" : "I'm not sure what can be added. Can you give an example of guidance we could give to developers?",
        "createdAt" : "2020-09-10T00:43:10Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "tags" : [
        ]
      },
      {
        "id" : "1406b95d-d9d4-4dd5-84b2-872574496ea2",
        "parentId" : "6bd9786c-9b5f-4fe8-af2a-4e300584d2c8",
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "As an example, `registerShuffle` is invoked with write lock held, while `unregisterShuffle` is invoked without any lock.\r\nAs a public api we are exposing, the locking semantics needs to be elaborated; so that users can evaluate what can be done safely/without contention, and what needs additional protection (for example, `updateMapOutput` can be performed without contention from `registerShuffle` or `registerMapOutput`)\r\n\r\nAdditionally, it also informs users about how to design their implementations. For example, if an implementation makes rpc calls (or other blocking calls) from `registerMapOutput` , there could be nontrivial side effects in driver.\r\n\r\n(I just picked some api calls to illustrate, we need to elaborate for each).",
        "createdAt" : "2020-09-10T06:01:23Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "94df0abb-ea72-4cbc-88fc-ac46c34a9fc5",
        "parentId" : "6bd9786c-9b5f-4fe8-af2a-4e300584d2c8",
        "authorId" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "body" : "Is it sufficient to simply say that all APIs need to have exclusive access from each other, at least locking on the shuffle id level?",
        "createdAt" : "2020-09-10T16:42:46Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "tags" : [
        ]
      },
      {
        "id" : "2a61a6bf-481e-4f7f-8b12-40d3d814a2af",
        "parentId" : "6bd9786c-9b5f-4fe8-af2a-4e300584d2c8",
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "`unregisterShuffle` currently does not lock ?",
        "createdAt" : "2020-09-12T15:50:11Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "e9d3b9b2-1d1d-4405-9cb2-5e8fb424e69a",
        "parentId" : "6bd9786c-9b5f-4fe8-af2a-4e300584d2c8",
        "authorId" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "body" : "Again, that's up to the implementation to handle, no?",
        "createdAt" : "2020-09-13T15:36:50Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "tags" : [
        ]
      },
      {
        "id" : "933c8a64-fcbf-4d74-9927-870f8e997fad",
        "parentId" : "6bd9786c-9b5f-4fe8-af2a-4e300584d2c8",
        "authorId" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "body" : "I was not referring to how implementations manage their state/locking (if they have additional state/coordination required, you are right, it has to be handled there - state managed across shuffles as an example for some custom impl).\r\n\r\nI was referring to what guarantees/expectations that implementations have from spark (`MapOutputTracker` currently) when these methods are invoked. We have to document this, so that implementation can be both aware of the MT-safety guarantees we provide (and at what granularity) - so that they can make reasonable assumptions about what can/cant be done in an implementation.\r\n\r\nFor example, as mentioned above, `registerShuffle` is invoked only with write lock is held for a particular shuffle. While `unregisterShuffle` does not have that guarantee.",
        "createdAt" : "2020-09-13T17:27:23Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "d35df420-57a9-43e8-b8d5-cad0f4002681",
        "tags" : [
        ]
      },
      {
        "id" : "68f226a3-9d59-42e2-867c-cf7d25eb76e3",
        "parentId" : "6bd9786c-9b5f-4fe8-af2a-4e300584d2c8",
        "authorId" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "body" : "The whole point of just saying that implementations must be thread-safe is that implementations cannot make _any_ guarantees about how the caller will invoke this API. Even if we can say that the current implementation of `MapOutputTracker` would guarantee locking on per-shuffle-id, for example, that isn't an API guarantee we can realistically make since `MapOutputTracker` is a module internal to Spark.\r\n\r\nI think saying that there is no guarantee about concurrent access to all methods suffices. But then that basically means \"the implementation should be thread-safe\". Is that reasonable, or do we need to be more granular than that?",
        "createdAt" : "2020-09-14T16:57:37Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "tags" : [
        ]
      }
    ],
    "commit" : "f69cba7d0632e7b260e38a0aa16cf560bd0d94cc",
    "line" : 30,
    "diffHunk" : "@@ -1,1 +28,32 @@ * metadata registration method in {@link #registerMapOutput(int, int, long, MapOutputMetadata)}.\n * <p>\n * Implementations MUST be thread-safe. Spark will invoke methods in this module in parallel.\n * <p>\n * A singleton instance of this module is instantiated on the driver via"
  },
  {
    "id" : "1c69b273-87ba-4a8a-9338-377242207f5d",
    "prId" : 28618,
    "prUrl" : "https://github.com/apache/spark/pull/28618#pullrequestreview-479766088",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "7e16db7c-cad8-4e0e-847d-a64bf16c9a71",
        "parentId" : null,
        "authorId" : "bea80117-7be3-4703-8d54-02b7bf73632c",
        "body" : "assume this is on the driver, might be nice just to mention.",
        "createdAt" : "2020-09-01T14:00:19Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "bea80117-7be3-4703-8d54-02b7bf73632c",
        "tags" : [
        ]
      }
    ],
    "commit" : "f69cba7d0632e7b260e38a0aa16cf560bd0d94cc",
    "line" : 23,
    "diffHunk" : "@@ -1,1 +21,25 @@ * :: Private ::\n *\n * A plugin that can monitor the storage of shuffle data from map tasks, and can provide\n * metadata to shuffle readers to aid their reading of shuffle blocks in reduce tasks.\n * <p>"
  },
  {
    "id" : "b4031286-c1d0-4d45-9c75-5ab7cfb3ac89",
    "prId" : 28618,
    "prUrl" : "https://github.com/apache/spark/pull/28618#pullrequestreview-485493020",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "b69f2e75-c2d2-4da7-b68c-580bcb4033b5",
        "parentId" : null,
        "authorId" : "bea80117-7be3-4703-8d54-02b7bf73632c",
        "body" : "why are we calling all of this private if we want people to implement?  Wouldn't developer api and evolving be better?",
        "createdAt" : "2020-09-01T14:02:36Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "bea80117-7be3-4703-8d54-02b7bf73632c",
        "tags" : [
        ]
      },
      {
        "id" : "c4df3209-7d28-476a-b77a-7ce83fe09d0f",
        "parentId" : "b69f2e75-c2d2-4da7-b68c-580bcb4033b5",
        "authorId" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "body" : "I believe this is being marked as private until we have the entire API completed and available to implement end to end. Right now the API is not really usable in any meaningful way.",
        "createdAt" : "2020-09-10T00:46:23Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "806aa501-9ea7-4cec-b017-a84d9a1602d8",
        "tags" : [
        ]
      }
    ],
    "commit" : "f69cba7d0632e7b260e38a0aa16cf560bd0d94cc",
    "line" : 21,
    "diffHunk" : "@@ -1,1 +19,23 @@\n/**\n * :: Private ::\n *\n * A plugin that can monitor the storage of shuffle data from map tasks, and can provide"
  },
  {
    "id" : "ad5575f9-3581-476d-afb7-6ad5a6e657ae",
    "prId" : 28618,
    "prUrl" : "https://github.com/apache/spark/pull/28618#pullrequestreview-479766088",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "75d9cbec-228a-40c9-8f6d-bf73cf6825a2",
        "parentId" : null,
        "authorId" : "bea80117-7be3-4703-8d54-02b7bf73632c",
        "body" : "it would be nice to have full java doc comments explaining parameter on all of these. Most are obvious but its still better especially if people are meant to implement. ",
        "createdAt" : "2020-09-01T14:04:36Z",
        "updatedAt" : "2020-10-17T18:44:19Z",
        "lastEditedBy" : "bea80117-7be3-4703-8d54-02b7bf73632c",
        "tags" : [
        ]
      }
    ],
    "commit" : "f69cba7d0632e7b260e38a0aa16cf560bd0d94cc",
    "line" : 42,
    "diffHunk" : "@@ -1,1 +40,44 @@   * @param shuffleId the unique identifier for the new shuffle stage\n   */\n  void registerShuffle(int shuffleId);\n\n  /**"
  }
]