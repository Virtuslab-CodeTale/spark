[
  {
    "id" : "552e8dc9-6139-4445-856a-287869d48446",
    "prId" : 28797,
    "prUrl" : "https://github.com/apache/spark/pull/28797#pullrequestreview-428677916",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "50f69220-d911-4854-b47e-094dde137707",
        "parentId" : null,
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "This fix is added to `SharedThriftServer ` not `SharedThriftServer` for a lower scope in this PR, but I think most of hive and `SharedSparkSession` related tests that need a dedicated JVM may cause by this.",
        "createdAt" : "2020-06-11T07:58:48Z",
        "updatedAt" : "2020-06-11T08:04:35Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      }
    ],
    "commit" : "c00ac4eefeee7262f252e4cdb811502523c9b0e2",
    "line" : 21,
    "diffHunk" : "@@ -1,1 +54,58 @@    } finally {\n      super.afterAll()\n      SessionState.detachSession()\n    }\n  }"
  },
  {
    "id" : "ab70d487-2fc8-4af9-bca3-1db88c876579",
    "prId" : 28797,
    "prUrl" : "https://github.com/apache/spark/pull/28797#pullrequestreview-430746518",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "45e049a7-d7c2-4dd1-8a44-020605f41394",
        "parentId" : null,
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "From some Jenkins jobs, NPE is reported here.\r\n```\r\nsbt.ForkMain$ForkError: java.lang.NullPointerException: null\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.afterAll(SharedThriftServer.scala:53)\r\n```",
        "createdAt" : "2020-06-15T15:18:44Z",
        "updatedAt" : "2020-06-15T15:18:44Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      }
    ],
    "commit" : "c00ac4eefeee7262f252e4cdb811502523c9b0e2",
    "line" : 18,
    "diffHunk" : "@@ -1,1 +51,55 @@  override def afterAll(): Unit = {\n    try {\n      hiveServer2.stop()\n    } finally {\n      super.afterAll()"
  },
  {
    "id" : "113c18a1-bd67-4132-bdf5-816d170e6756",
    "prId" : 28797,
    "prUrl" : "https://github.com/apache/spark/pull/28797#pullrequestreview-430750173",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "af787a75-6d89-4117-999e-5dd1ca1bb289",
        "parentId" : null,
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "Before NPE occurs, this failed.\r\n```\r\nThriftServerWithSparkContextInHttpSuite:\r\n05:42:37.405 WARN hive.metastore: Failed to connect to the MetaStore Server...\r\norg.apache.thrift.transport.TTransportException: java.net.ConnectException: Connection refused (Connection refused)\r\n\tat org.apache.thrift.transport.TSocket.open(TSocket.java:226)\r\n\tat org.apache.hadoop.hive.metastore.HiveMetaStoreClient.open(HiveMetaStoreClient.java:480)\r\n\tat org.apache.hadoop.hive.metastore.HiveMetaStoreClient.<init>(HiveMetaStoreClient.java:247)\r\n\tat org.apache.hadoop.hive.metastore.HiveMetaStoreClient.<init>(HiveMetaStoreClient.java:129)\r\n\tat org.apache.hive.service.cli.CLIService.start(CLIService.java:152)\r\n\tat org.apache.hive.service.CompositeService.start(CompositeService.java:70)\r\n\tat org.apache.hive.service.server.HiveServer2.start(HiveServer2.java:105)\r\n\tat org.apache.spark.sql.hive.thriftserver.HiveThriftServer2.start(HiveThriftServer2.scala:161)\r\n\tat org.apache.spark.sql.hive.thriftserver.HiveThriftServer2$.startWithContext(HiveThriftServer2.scala:62)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.startThriftServer(SharedThriftServer.scala:92)\r\n```",
        "createdAt" : "2020-06-15T15:22:40Z",
        "updatedAt" : "2020-06-15T15:22:40Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      }
    ],
    "commit" : "c00ac4eefeee7262f252e4cdb811502523c9b0e2",
    "line" : 63,
    "diffHunk" : "@@ -1,1 +90,94 @@\n    try {\n      hiveServer2 = HiveThriftServer2.startWithContext(sqlContext)\n      hiveServer2.getServices.asScala.foreach {\n        case t: ThriftCLIService =>"
  },
  {
    "id" : "8f9a4146-1770-4e56-9d93-388e7d921bff",
    "prId" : 28751,
    "prUrl" : "https://github.com/apache/spark/pull/28751#pullrequestreview-427077485",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "e104ea02-49a0-4276-93c2-b7b1bd44dfd8",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "so we may not output this log?",
        "createdAt" : "2020-06-08T12:10:59Z",
        "updatedAt" : "2020-06-09T12:42:50Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "4b46bd26-f848-486b-9f4e-28436a6e88c1",
        "parentId" : "e104ea02-49a0-4276-93c2-b7b1bd44dfd8",
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "Before this fix, yes. The port binding is in another background thread.",
        "createdAt" : "2020-06-08T12:16:42Z",
        "updatedAt" : "2020-06-09T12:42:50Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      },
      {
        "id" : "5ff31d3c-e556-4c57-8f07-edf061c3ed64",
        "parentId" : "e104ea02-49a0-4276-93c2-b7b1bd44dfd8",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "how does this patch fix it? It seems you just added a try-catch?",
        "createdAt" : "2020-06-08T12:22:31Z",
        "updatedAt" : "2020-06-09T12:42:50Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "c7d25b26-49e0-43a8-8895-eb74caecc49f",
        "parentId" : "e104ea02-49a0-4276-93c2-b7b1bd44dfd8",
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "With https://github.com/apache/spark/pull/28751/files#diff-7610697b4f8f1bc4842c77e50807914cR178 and its implementations, the port binding is done in the same thread where we call `getPortNumber` later.",
        "createdAt" : "2020-06-08T12:25:26Z",
        "updatedAt" : "2020-06-09T12:42:50Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      },
      {
        "id" : "d643e2a5-44d6-4664-8e92-6e4540d13ccb",
        "parentId" : "e104ea02-49a0-4276-93c2-b7b1bd44dfd8",
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "https://github.com/apache/spark/pull/28651#discussion_r435932239 . there was a discussion with @juliuszsompolski before ",
        "createdAt" : "2020-06-08T12:27:27Z",
        "updatedAt" : "2020-06-09T12:42:50Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      },
      {
        "id" : "3b716b7c-7491-45c3-a2db-2fea1dbcd241",
        "parentId" : "e104ea02-49a0-4276-93c2-b7b1bd44dfd8",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "ah I see!",
        "createdAt" : "2020-06-08T12:36:26Z",
        "updatedAt" : "2020-06-09T12:42:50Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "a75a3d50-7780-47b5-91bb-c64c824ef932",
        "parentId" : "e104ea02-49a0-4276-93c2-b7b1bd44dfd8",
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "Take `ThriftBinaryCLIService` for an example\r\nBefore:\r\n  we do `TThreadPoolServer` initialization and `serve` in the same `run` function of the background thread.  Then if we call getPortNumber right after `startWithContext`, concurrency issue will occur. The `portNum` may not reset yet when we call.\r\n\r\nAfter:\r\n we do `TThreadPoolServer` initialization in the current thread and do `serve` in the `run` function of the background thread.\r\n",
        "createdAt" : "2020-06-08T12:37:39Z",
        "updatedAt" : "2020-06-09T12:42:50Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      },
      {
        "id" : "405b8b30-7086-4860-9dde-8c672888c848",
        "parentId" : "e104ea02-49a0-4276-93c2-b7b1bd44dfd8",
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "Ah, I see. Nice catch.",
        "createdAt" : "2020-06-09T12:26:16Z",
        "updatedAt" : "2020-06-09T12:42:50Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      }
    ],
    "commit" : "04f0a1cb58897fc272a3021e68a19cfd2ecf26b9",
    "line" : 52,
    "diffHunk" : "@@ -1,1 +92,96 @@        case t: ThriftCLIService =>\n          serverPort = t.getPortNumber\n          logInfo(s\"Started HiveThriftServer2: port=$serverPort, attempt=$attempt\")\n        case _ =>\n      }"
  },
  {
    "id" : "869a6ab1-e8dd-4141-86de-6b1fd51ad106",
    "prId" : 28751,
    "prUrl" : "https://github.com/apache/spark/pull/28751#pullrequestreview-427105350",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "53a130ef-292c-48c8-bdf2-f14c2889c865",
        "parentId" : null,
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "nit format:\r\n```\r\nprivate lazy val jdbcUri = if (mode == ServerMode.http) {\r\n    s\"jdbc:hive2://localhost:$serverPort/default;transportMode=http;httpPath=cliservice\"\r\n  } else {\r\n    s\"jdbc:hive2://localhost:$serverPort\"\r\n  }\r\n```\r\n?",
        "createdAt" : "2020-06-09T12:16:05Z",
        "updatedAt" : "2020-06-09T12:42:50Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "740d76e0-26ca-4676-a6b2-4c84beb3ddb5",
        "parentId" : "53a130ef-292c-48c8-bdf2-f14c2889c865",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "I think the existing format is correct.",
        "createdAt" : "2020-06-09T12:48:48Z",
        "updatedAt" : "2020-06-09T12:48:48Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "04f0a1cb58897fc272a3021e68a19cfd2ecf26b9",
    "line" : 17,
    "diffHunk" : "@@ -1,1 +60,64 @@  } else {\n    s\"jdbc:hive2://localhost:$serverPort\"\n  }\n\n  protected def withJdbcStatement(fs: (Statement => Unit)*): Unit = {"
  },
  {
    "id" : "d360f409-0f4a-449d-add8-a64c7691039a",
    "prId" : 28651,
    "prUrl" : "https://github.com/apache/spark/pull/28651#pullrequestreview-419138032",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "62364a7e-9158-464d-8e3d-54c95d2ecf4d",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "shall we log something if we fail to bind the port?",
        "createdAt" : "2020-05-27T10:23:28Z",
        "updatedAt" : "2020-05-29T02:14:20Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "19438236-d89f-49da-a15f-6c0b076ed1ae",
        "parentId" : "62364a7e-9158-464d-8e3d-54c95d2ecf4d",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "or fail here?",
        "createdAt" : "2020-05-27T10:23:50Z",
        "updatedAt" : "2020-05-29T02:14:20Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "79ce22ea-f086-4439-854e-b918373a565a",
        "parentId" : "62364a7e-9158-464d-8e3d-54c95d2ecf4d",
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "\r\n> shall we log something if we fail to bind the port?\r\n\r\nthere will be a requirement here https://github.com/apache/spark/pull/28651/files#diff-ee6e4132bcb9b33369bd5a3567937607R58 after this.\r\nMaybe enough for checkingï¼Ÿ\r\nI think it might be unnecessary to log for each failed round.\r\n> or fail here?\r\n\r\nWe can not fail in this match-case. this is also for other services registered. or maybe we can add another case for matching - `case t: ThriftCLIService =>`?",
        "createdAt" : "2020-05-27T10:37:04Z",
        "updatedAt" : "2020-05-29T02:14:20Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      },
      {
        "id" : "d545822e-2c0c-4f7c-baa7-6b88b470f8ff",
        "parentId" : "62364a7e-9158-464d-8e3d-54c95d2ecf4d",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "oh i see, it's fine.",
        "createdAt" : "2020-05-27T12:24:41Z",
        "updatedAt" : "2020-05-29T02:14:20Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "099d261c126496ecccd3900fa902fec60e272f10",
    "line" : 64,
    "diffHunk" : "@@ -1,1 +80,84 @@        serverPort = t.getPortNumber\n        logInfo(s\"Started HiveThriftServer2: port=$serverPort, attempt=$attempt\")\n      case _ =>\n    }\n"
  },
  {
    "id" : "ac269001-542b-4096-80ac-c03ba45ec667",
    "prId" : 28651,
    "prUrl" : "https://github.com/apache/spark/pull/28651#pullrequestreview-420606753",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f6656048-0909-4d21-a40a-7d2527a5abb5",
        "parentId" : null,
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "nit: `0.toString` -> `\"0\"`. btw, we don't need to set `HIVE_SERVER2_THRIFT_HTTP_PORT` here? It seems `HIVE_SERVER2_THRIFT_PORT` is only for a binary mode though.",
        "createdAt" : "2020-05-29T00:23:05Z",
        "updatedAt" : "2020-05-29T02:14:20Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "0f5e0e1e-a05c-4993-b8ad-d9daa217afb4",
        "parentId" : "f6656048-0909-4d21-a40a-7d2527a5abb5",
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "thanks.\r\n\r\nthe `HTTP` mode is not used here, so the `.._THRIFT_PORT` is enough",
        "createdAt" : "2020-05-29T02:05:45Z",
        "updatedAt" : "2020-05-29T02:14:20Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      }
    ],
    "commit" : "099d261c126496ecccd3900fa902fec60e272f10",
    "line" : 57,
    "diffHunk" : "@@ -1,1 +73,77 @@    val sqlContext = spark.newSession().sqlContext\n    // Set the HIVE_SERVER2_THRIFT_PORT to 0, so it could randomly pick any free port to use.\n    // It's much more robust than set a random port generated by ourselves ahead\n    sqlContext.setConf(ConfVars.HIVE_SERVER2_THRIFT_PORT.varname, \"0\")\n    hiveServer2 = HiveThriftServer2.startWithContext(sqlContext)"
  },
  {
    "id" : "eb1184d0-bad9-468b-a89c-e5cb75387907",
    "prId" : 28651,
    "prUrl" : "https://github.com/apache/spark/pull/28651#pullrequestreview-425358729",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "50c9d509-6517-4ea1-84d7-1bfd65e66a92",
        "parentId" : null,
        "authorId" : "e5beb795-ac0e-4bd6-ad66-708215b8ae58",
        "body" : "HiveThriftServer2.startWithContext -> HiveThriftServer2.start() -> CompositeService.start() -> Service.start()...\r\nThriftCLIService.start() creates `new Thread(this).start();`\r\nSo ThriftBinaryCLIService / ThriftHttpCLIService run() is launched in a background thread. I think this can race before the actual port gets assigned?",
        "createdAt" : "2020-06-05T13:47:23Z",
        "updatedAt" : "2020-06-05T13:47:24Z",
        "lastEditedBy" : "e5beb795-ac0e-4bd6-ad66-708215b8ae58",
        "tags" : [
        ]
      },
      {
        "id" : "3088533a-8394-498b-a52f-9a6fcdafcf8e",
        "parentId" : "50c9d509-6517-4ea1-84d7-1bfd65e66a92",
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "I run the tests with http mode locally with  #28738 and\r\n```sql\r\n build/sbt \"hive-thriftserver/test-only *HiveThriftHttpServerSuite\" -Phive -Phive-thriftserver -Dsbt.override.build.repos=true -Phive-2.3\r\n```\r\nI check the logs in `target/unit-tests.log`\r\n\r\n```java\r\n20/06/05 06:35:55.237 pool-1-thread-1 INFO AbstractService: Service:ThriftHttpCLIService is started.\r\n20/06/05 06:35:55.237 pool-1-thread-1 INFO AbstractService: Service:HiveServer2 is started.\r\n20/06/05 06:35:55.326 Thread-17 INFO Server: jetty-9.4.18.v20190429; built: 2019-04-29T20:42:08.989Z; git: e1bc35120a6617ee3df052294e433f3a25ce7097; jvm 1.8.0_251-b08\r\n20/06/05 06:35:55.358 Thread-17 INFO session: DefaultSessionIdManager workerName=node0\r\n20/06/05 06:35:55.358 Thread-17 INFO session: No SessionScavenger set, using defaults\r\n20/06/05 06:35:55.359 Thread-17 INFO session: node0 Scavenging every 660000ms\r\n20/06/05 06:35:55.366 Thread-17 INFO ContextHandler: Started o.e.j.s.ServletContextHandler@23f4b16a{/,null,AVAILABLE}\r\n20/06/05 06:35:55.438 Thread-17 INFO AbstractConnector: Started ServerConnector@1b76f67f{HTTP/1.1,[http/1.1]}{0.0.0.0:55923}\r\n20/06/05 06:35:55.438 Thread-17 INFO Server: Started @7043ms\r\n20/06/05 06:35:55.438 Thread-17 INFO ThriftCLIService: Started ThriftHttpCLIService in http mode on port 55923 path=/cliservice/* with 5...500 worker threads\r\n20/06/05 06:35:55.442 pool-1-thread-1 INFO Utils: Supplied authorities: localhost:0\r\n20/06/05 06:35:55.442 pool-1-thread-1 WARN Utils: ***** JDBC param deprecation *****\r\n20/06/05 06:35:55.442 pool-1-thread-1 WARN Utils: The use of hive.server2.transport.mode is deprecated.\r\n20/06/05 06:35:55.442 pool-1-thread-1 WARN Utils: Please use transportMode like so: jdbc:hive2://<host>:<port>/dbName;transportMode=<transport_mode_value>\r\n20/06/05 06:35:55.442 pool-1-thread-1 WARN Utils: ***** JDBC param deprecation *****\r\n20/06/05 06:35:55.442 pool-1-thread-1 WARN Utils: The use of hive.server2.thrift.http.path is deprecated.\r\n20/06/05 06:35:55.442 pool-1-thread-1 WARN Utils: Please use httpPath like so: jdbc:hive2://<host>:<port>/dbName;httpPath=<http_path_value>\r\n20/06/05 06:35:55.442 pool-1-thread-1 INFO Utils: Resolved authority: localhost:0\r\n20/06/05 06:35:55.663 pool-1-thread-1 ERROR HiveConnection: Error opening session\r\norg.apache.thrift.transport.TTransportException: org.apache.http.conn.HttpHostConnectException: Connect to localhost:80 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused (Connection refused)\r\n\tat org.apache.thrift.transport.THttpClient.flushUsingHttpClient(THttpClient.java:297)\r\n\tat org.apache.thrift.transport.THttpClient.flush(THttpClient.java:316)\r\n\tat org.apache.thrift.TServiceClient.sendBase(TServiceClient.java:73)\r\n\tat org.apache.thrift.TServiceClient.sendBase(TServiceClient.java:62)\r\n\tat org.apache.hive.service.rpc.thrift.TCLIService$Client.send_OpenSession(TCLIService.java:162)\r\n\tat org.apache.hive.service.rpc.thrift.TCLIService$Client.OpenSession(TCLIService.java:154)\r\n\tat org.apache.hive.jdbc.HiveConnection.openSession(HiveConnection.java:680)\r\n\tat org.apache.hive.jdbc.HiveConnection.<init>(HiveConnection.java:200)\r\n\tat org.apache.hive.jdbc.HiveDriver.connect(HiveDriver.java:107)\r\n\tat java.sql.DriverManager.getConnection(DriverManager.java:664)\r\n\tat java.sql.DriverManager.getConnection(DriverManager.java:247)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.$anonfun$withMultipleConnectionJdbcStatement$1(SharedThriftServer.scala:106)\r\n\tat scala.collection.TraversableLike.$anonfun$map$1(TraversableLike.scala:238)\r\n\tat scala.collection.IndexedSeqOptimized.foreach(IndexedSeqOptimized.scala:36)\r\n\tat scala.collection.IndexedSeqOptimized.foreach$(IndexedSeqOptimized.scala:33)\r\n\tat scala.collection.mutable.WrappedArray.foreach(WrappedArray.scala:38)\r\n\tat scala.collection.TraversableLike.map(TraversableLike.scala:238)\r\n\tat scala.collection.TraversableLike.map$(TraversableLike.scala:231)\r\n\tat scala.collection.AbstractTraversable.map(Traversable.scala:108)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.withMultipleConnectionJdbcStatement(SharedThriftServer.scala:106)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.withMultipleConnectionJdbcStatement$(SharedThriftServer.scala:105)\r\n\tat org.apache.spark.sql.hive.thriftserver.HiveThriftHttpServerSuite.withMultipleConnectionJdbcStatement(HiveThriftServer2Suites.scala:280)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.withJdbcStatement(SharedThriftServer.scala:141)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.withJdbcStatement$(SharedThriftServer.scala:140)\r\n\tat org.apache.spark.sql.hive.thriftserver.HiveThriftHttpServerSuite.withJdbcStatement(HiveThriftServer2Suites.scala:280)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.$anonfun$startThriftServer$4(SharedThriftServer.scala:166)\r\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.java:23)\r\n\tat org.scalatest.concurrent.Eventually.makeAValiantAttempt$1(Eventually.scala:395)\r\n\tat org.scalatest.concurrent.Eventually.tryTryAgain$1(Eventually.scala:409)\r\n\tat org.scalatest.concurrent.Eventually.eventually(Eventually.scala:439)\r\n\tat org.scalatest.concurrent.Eventually.eventually$(Eventually.scala:391)\r\n\tat org.apache.spark.sql.hive.thriftserver.HiveThriftHttpServerSuite.eventually(HiveThriftServer2Suites.scala:280)\r\n\tat org.scalatest.concurrent.Eventually.eventually(Eventually.scala:308)\r\n\tat org.scalatest.concurrent.Eventually.eventually$(Eventually.scala:307)\r\n\tat org.apache.spark.sql.hive.thriftserver.HiveThriftHttpServerSuite.eventually(HiveThriftServer2Suites.scala:280)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.startThriftServer(SharedThriftServer.scala:165)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.$anonfun$beforeAll$1(SharedThriftServer.scala:71)\r\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.java:23)\r\n\tat scala.util.Try$.apply(Try.scala:213)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.beforeAll(SharedThriftServer.scala:71)\r\n\tat org.apache.spark.sql.hive.thriftserver.SharedThriftServer.beforeAll$(SharedThriftServer.scala:68)\r\n\tat org.apache.spark.sql.hive.thriftserver.HiveThriftHttpServerSuite.beforeAll(HiveThriftServer2Suites.scala:280)\r\n\tat org.scalatest.BeforeAndAfterAll.liftedTree1$1(BeforeAndAfterAll.scala:212)\r\n\tat org.scalatest.BeforeAndAfterAll.run(BeforeAndAfterAll.scala:210)\r\n\tat org.scalatest.BeforeAndAfterAll.run$(BeforeAndAfterAll.scala:208)\r\n\tat org.apache.spark.SparkFunSuite.run(SparkFunSuite.scala:59)\r\n\tat org.scalatest.tools.Framework.org$scalatest$tools$Framework$$runSuite(Framework.scala:317)\r\n\tat org.scalatest.tools.Framework$ScalaTestTask.execute(Framework.scala:510)\r\n\tat sbt.ForkMain$Run$2.call(ForkMain.java:296)\r\n\tat sbt.ForkMain$Run$2.call(ForkMain.java:286)\r\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\nCaused by: org.apache.http.conn.HttpHostConnectException: Connect to localhost:80 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused (Connection refused)\r\n\tat org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:159)\r\n\tat org.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:373)\r\n\tat org.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:394)\r\n\tat org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:237)\r\n\tat org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:185)\r\n\tat org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:89)\r\n\tat org.apache.http.impl.execchain.ServiceUnavailableRetryExec.execute(ServiceUnavailableRetryExec.java:85)\r\n\tat org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:110)\r\n\tat org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)\r\n\tat org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:118)\r\n\tat org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)\r\n\tat org.apache.thrift.transport.THttpClient.flushUsingHttpClient(THttpClient.java:251)\r\n\t... 53 more\r\nCaused by: java.net.ConnectException: Connection refused (Connection refused)\r\n\tat java.net.PlainSocketImpl.socketConnect(Native Method)\r\n\tat java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)\r\n\tat java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)\r\n\tat java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)\r\n\tat java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)\r\n\tat java.net.Socket.connect(Socket.java:606)\r\n\tat org.apache.http.conn.socket.PlainConnectionSocketFactory.connectSocket(PlainConnectionSocketFactory.java:75)\r\n\tat org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:142)\r\n\t... 64 more\r\n20/06/05 06:35:55.665 pool-1-thread-1 WARN HiveConnection: Failed to connect to localhost:0\r\n```\r\n\r\nThe starting phase looks ok to me and the port logged assigned `Started ThriftHttpCLIService in http mode on port 55923 path=/cliservice/* with 5...500`\r\n",
        "createdAt" : "2020-06-05T14:07:53Z",
        "updatedAt" : "2020-06-05T14:08:17Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      },
      {
        "id" : "8545d8df-ee11-4749-8bad-f777255c2666",
        "parentId" : "50c9d509-6517-4ea1-84d7-1bfd65e66a92",
        "authorId" : "e5beb795-ac0e-4bd6-ad66-708215b8ae58",
        "body" : "The log line `Started ThriftHttpCLIService in http mode on port 55923 path=/cliservice/* with 5...500` is logged in a background thread that is launched to start the server, so\r\n```\r\n        serverPort = t.getPortNumber\r\n```\r\nmay be executed before it's assigned and be still 0 at this point.",
        "createdAt" : "2020-06-05T14:19:36Z",
        "updatedAt" : "2020-06-05T14:19:37Z",
        "lastEditedBy" : "e5beb795-ac0e-4bd6-ad66-708215b8ae58",
        "tags" : [
        ]
      },
      {
        "id" : "57fa1012-d258-4bad-ad06-bbe334e9cfb7",
        "parentId" : "50c9d509-6517-4ea1-84d7-1bfd65e66a92",
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "Ah I see",
        "createdAt" : "2020-06-05T14:36:00Z",
        "updatedAt" : "2020-06-05T14:36:01Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      }
    ],
    "commit" : "099d261c126496ecccd3900fa902fec60e272f10",
    "line" : 62,
    "diffHunk" : "@@ -1,1 +78,82 @@    hiveServer2.getServices.asScala.foreach {\n      case t: ThriftCLIService if t.getPortNumber != 0 =>\n        serverPort = t.getPortNumber\n        logInfo(s\"Started HiveThriftServer2: port=$serverPort, attempt=$attempt\")\n      case _ =>"
  }
]