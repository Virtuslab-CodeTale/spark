[
  {
    "id" : "b0cb9d33-50b8-45f5-af49-4c7d95a70e2b",
    "prId" : 32448,
    "prUrl" : "https://github.com/apache/spark/pull/32448#pullrequestreview-656210591",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "ed16a99f-47ba-496f-a19b-66a53b40c733",
        "parentId" : null,
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "Can we update migration guide (https://github.com/apache/spark/blob/master/docs/sql-migration-guide.md)?",
        "createdAt" : "2021-05-10T06:13:50Z",
        "updatedAt" : "2021-05-10T06:13:50Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      },
      {
        "id" : "3994884e-f738-4d3a-b263-a493b99be052",
        "parentId" : "ed16a99f-47ba-496f-a19b-66a53b40c733",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "is this an expected behavior change? and why do we prefer the new behavior?",
        "createdAt" : "2021-05-10T06:57:15Z",
        "updatedAt" : "2021-05-10T06:57:23Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "4337ccba-e9f6-42d9-a9c0-a24535eb0c71",
        "parentId" : "ed16a99f-47ba-496f-a19b-66a53b40c733",
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "Yeah, the nested fields don't necessarily have to be sorted. The behaviour should be same or at least similar with the outermost schema. Sorting is sort of unexpected I think.",
        "createdAt" : "2021-05-10T08:21:24Z",
        "updatedAt" : "2021-05-10T08:21:25Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      },
      {
        "id" : "1fc908bd-a7d7-45cd-87eb-ec4c20957ccc",
        "parentId" : "ed16a99f-47ba-496f-a19b-66a53b40c733",
        "authorId" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "body" : "You want a 3.1 -> 3.2 migration message saying fields are no longer sorted but instead kept in order with new fields added to the end?",
        "createdAt" : "2021-05-10T13:09:08Z",
        "updatedAt" : "2021-05-10T13:09:08Z",
        "lastEditedBy" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "tags" : [
        ]
      },
      {
        "id" : "234b7c5c-b4d6-4de5-ba40-b08aaf88e733",
        "parentId" : "ed16a99f-47ba-496f-a19b-66a53b40c733",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "yes",
        "createdAt" : "2021-05-10T19:37:48Z",
        "updatedAt" : "2021-05-10T19:37:48Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "dbe0afcf-7fca-4abc-a11e-6bfbcf79f673",
        "parentId" : "ed16a99f-47ba-496f-a19b-66a53b40c733",
        "authorId" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "body" : "Following on to that, how is it determined when things are backported to previous releases (3.1 in this case) versus saved for the next minor release? Is that up to submitters or do maintainers make that call? There's a little bit of a \"behavior change\" here, though it's mostly a bug fix. Similar with https://github.com/apache/spark/pull/32338, where it's a bug fix that could be useful in a 3.1 patch release.",
        "createdAt" : "2021-05-11T01:30:09Z",
        "updatedAt" : "2021-05-11T01:30:09Z",
        "lastEditedBy" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "tags" : [
        ]
      }
    ],
    "commit" : "5762ddc83e96b640ffdd4125c182646bf9fb03ff",
    "line" : 50,
    "diffHunk" : "@@ -1,1 +713,717 @@      assert(unionDf.schema.toDDL ==\n        \"`id` INT,`a` STRUCT<`a`: INT, `b`: BIGINT, \" +\n          \"`nested`: STRUCT<`a`: INT, `c`: STRING, `A`: INT, `b`: BIGINT>>\")\n      checkAnswer(unionDf,\n        Row(0, Row(0, 1, Row(1, \"2\", null, null))) ::"
  },
  {
    "id" : "849eef8b-3c36-4d22-9fed-e4d280a5f632",
    "prId" : 32448,
    "prUrl" : "https://github.com/apache/spark/pull/32448#pullrequestreview-662892407",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "Can you clarify which step fails? I'm reading this test but can't think of how it can fail without this PR.",
        "createdAt" : "2021-05-17T16:29:55Z",
        "updatedAt" : "2021-05-17T16:29:55Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "b42b175d-2130-4332-b562-fbaadb621f23",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "body" : "The union throws an analysis exception because the right side gets corrupted. It's the same example I have in the issue: https://issues.apache.org/jira/browse/SPARK-35290",
        "createdAt" : "2021-05-17T16:52:10Z",
        "updatedAt" : "2021-05-17T16:52:10Z",
        "lastEditedBy" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "tags" : [
        ]
      },
      {
        "id" : "c33ebb53-8701-4e9d-9e8b-1e97b8ee0907",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "I see. From the JIRA, seems the problem is `b:struct<ba:string:bb:string>` becomes `b:struct<aa:string,bb:string>` due to some reasons. Can we fix the bug surgically without changing how the fields are ordered? Or do we have other reasons to change the behavior?",
        "createdAt" : "2021-05-17T17:21:45Z",
        "updatedAt" : "2021-05-17T17:21:45Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "e18952b0-be64-4c6e-ab0d-c031fb831d5a",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "body" : "I found one tweak that seemed to fix the issue but made the deeply nested case a lot slower to resolve. I went down this route because it sounded like this would have been the ideal behavior originally but sorting seemed like the only option. And it simplifies things a little bit and uses existing struct merging functionality.",
        "createdAt" : "2021-05-17T17:33:34Z",
        "updatedAt" : "2021-05-17T17:33:34Z",
        "lastEditedBy" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "tags" : [
        ]
      },
      {
        "id" : "c51ddb55-8a7b-457f-ace2-00e9524c8e48",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "Can you open a PR for that tweak? If possible it's better to fix a bug without changing the designed behavior.",
        "createdAt" : "2021-05-18T14:27:05Z",
        "updatedAt" : "2021-05-18T14:27:05Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "938f1bea-61f9-4963-8e39-a6820e10d172",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "body" : "It was \"designed\" because it was thought to be the only way. The author said this might be a better approach. I can see if I can remember what that update was, never thoroughly tested it",
        "createdAt" : "2021-05-18T14:59:04Z",
        "updatedAt" : "2021-05-18T14:59:04Z",
        "lastEditedBy" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "tags" : [
        ]
      },
      {
        "id" : "f2962fe7-ce8f-4165-9642-aa92a5dd8da3",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "I think sorting is reasonable as well. `df1.unionByName(df2)` can always have the same schema of `df2.unionByName(df1)`",
        "createdAt" : "2021-05-18T15:16:49Z",
        "updatedAt" : "2021-05-18T15:16:49Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "c23a3c24-61fe-465e-8a71-9ae4cb5d06b7",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "body" : "It's just weird because it's different behavior than every other part of spark. `withColumn` and `withField` both append to the end. And currently before this PR and if the I applied the tweak `df1.unionByName(df2, True)` would not always have the same schema as `df2.unionByName(df1, True)`. It only sorts nested struct fields, not the top level attributes.",
        "createdAt" : "2021-05-18T15:53:09Z",
        "updatedAt" : "2021-05-18T15:53:27Z",
        "lastEditedBy" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "tags" : [
        ]
      },
      {
        "id" : "7b48ee45-ca29-42fc-a557-1286e386404a",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "I see. So this PR mainly proposes to change the behavior, and fixing a bug is just a bonus.",
        "createdAt" : "2021-05-18T16:16:33Z",
        "updatedAt" : "2021-05-18T16:16:33Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "147afadc-a70e-4469-99e9-6579fd45094a",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "body" : "I guess you can look at it that way. It was the most effective way to fix the bug and simplify the code in the process (and not introduce a potential performance issue)",
        "createdAt" : "2021-05-18T17:03:16Z",
        "updatedAt" : "2021-05-18T17:03:16Z",
        "lastEditedBy" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "tags" : [
        ]
      },
      {
        "id" : "955b1786-fc49-4a55-83a2-568aa0314a8a",
        "parentId" : "90ca8fcf-ebc1-4609-9f30-2dd35ef0d596",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "I originally planed to work on to get rid of the sorting behavior but have no time on it. I think it is more consistent with top-level union by name behavior. Currently this approach looks much simpler than `withField` approach and can easily get rid of the sorting behavior. ",
        "createdAt" : "2021-05-19T08:11:56Z",
        "updatedAt" : "2021-05-19T08:11:56Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "5762ddc83e96b640ffdd4125c182646bf9fb03ff",
    "line" : 142,
    "diffHunk" : "@@ -1,1 +799,803 @@    checkAnswer(unionDf,\n      Row(Row(null, Row(null, \"ba\"))) ::\n      Row(Row(Row(\"aa\"), Row(\"bb\", null))) :: Nil)\n  }\n"
  }
]