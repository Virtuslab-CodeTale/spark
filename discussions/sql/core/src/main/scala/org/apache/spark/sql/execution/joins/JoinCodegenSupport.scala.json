[
  {
    "id" : "2da8772e-accb-433d-ac1a-612210431c2a",
    "prId" : 31736,
    "prUrl" : "https://github.com/apache/spark/pull/31736#pullrequestreview-604046925",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "ff3b46b3-1155-4df9-8fd2-8d84432308e8",
        "parentId" : null,
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "This is copied from `HashJoin.scala: getJoinCondition()`.",
        "createdAt" : "2021-03-04T12:30:00Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      }
    ],
    "commit" : "6f6d511e571a2109cba4dcd6b31fa3def4e44e21",
    "line" : 38,
    "diffHunk" : "@@ -1,1 +36,40 @@   *         and generated code for variables of build side.\n   */\n  protected def getJoinCondition(\n      ctx: CodegenContext,\n      streamVars: Seq[ExprCode],"
  },
  {
    "id" : "9766a521-8152-4e01-a27f-490164832703",
    "prId" : 31736,
    "prUrl" : "https://github.com/apache/spark/pull/31736#pullrequestreview-604047078",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "5a0a58df-7fe1-4937-a7f7-dc0118ccefe7",
        "parentId" : null,
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "This is copied from `HashJoin.scala: genBuildSideVars()`.",
        "createdAt" : "2021-03-04T12:30:10Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      }
    ],
    "commit" : "6f6d511e571a2109cba4dcd6b31fa3def4e44e21",
    "line" : 68,
    "diffHunk" : "@@ -1,1 +66,70 @@   * Generates the code for variables of build side.\n   */\n  protected def genBuildSideVars(\n      ctx: CodegenContext,\n      buildRow: String,"
  },
  {
    "id" : "92efd25e-1644-4991-864a-1028948b2c83",
    "prId" : 31736,
    "prUrl" : "https://github.com/apache/spark/pull/31736#pullrequestreview-605684174",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "d8acfeb7-d6d1-46af-9f75-f4863648f28f",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "This is not true for left-semi/anti, but is fine as this PR only supports inner like.",
        "createdAt" : "2021-03-05T09:00:27Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "71690303-d136-45af-bb7b-c351d61c18e2",
        "parentId" : "d8acfeb7-d6d1-46af-9f75-f4863648f28f",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "@cloud-fan - I will clean up in another PR then.",
        "createdAt" : "2021-03-06T00:23:43Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      }
    ],
    "commit" : "6f6d511e571a2109cba4dcd6b31fa3def4e44e21",
    "line" : 79,
    "diffHunk" : "@@ -1,1 +77,81 @@        ev\n      } else {\n        // the variables are needed even there is no matched rows\n        val isNull = ctx.freshName(\"isNull\")\n        val value = ctx.freshName(\"value\")"
  },
  {
    "id" : "0b5e6696-ce11-43f1-91d4-245580a5d03f",
    "prId" : 31736,
    "prUrl" : "https://github.com/apache/spark/pull/31736#pullrequestreview-607038872",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "This is coped so my question may not be related to this PR: the join condition can refer to columns from stream side, why don't we need to evaluate variables from the stream side?",
        "createdAt" : "2021-03-05T09:12:43Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "5bf98084-4490-4bab-a7fc-7ab00dba716f",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "This seems like a problem. In `HashJoin`, we have this at the beginning\r\n```\r\n         |// generate join key for stream side\r\n         |${keyEv.code}\r\n```\r\n\r\nShall we do something similar in BroadcastNestedLoopJoinExec?",
        "createdAt" : "2021-03-05T09:15:30Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "7ba6d167-783a-4651-b10b-0dbfc3fa5897",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "> why don't we need to evaluate variables from the stream side?\r\n\r\n@cloud-fan - `input` here is the generated code for streamed side. The code is generated below with `ctx.currentVars = input ++ buildVars`.",
        "createdAt" : "2021-03-05T09:16:15Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      },
      {
        "id" : "635e53a6-2fd4-42ae-91a8-b3aff0a32a53",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "> Shall we do something similar in BroadcastNestedLoopJoinExec?\r\n\r\nWe don't have join key for streamed side in `BroadcastNestedLoopJoinExec`, i.e. non-equal joins.",
        "createdAt" : "2021-03-05T09:17:21Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      },
      {
        "id" : "0a53071b-e301-421f-9b28-4d1773f4fd02",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "`input` also includes `buidVars`, my question is why this line of code here only handles build side not stream side.",
        "createdAt" : "2021-03-05T09:32:01Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "78d07666-1121-425b-bead-bda4dde30dc5",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "`evaluateRequiredVariables` is for performance purpose (eagerly evaluate some expressios and put them in vars), so this is not about correctness and is hard to test.",
        "createdAt" : "2021-03-05T09:33:54Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "d4f98df6-4cff-4754-a66c-d2a5a998b6ce",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "Discussed offline, added code to eagerly evaluate streamed side as well. Thanks @cloud-fan for pointing it out.",
        "createdAt" : "2021-03-06T00:23:11Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      },
      {
        "id" : "22944841-4f35-47bf-8db2-ed3b16c3dc9c",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "The variables from stream side are be already evaluated before `doConsume` is called. So you don't need to include stream side variables again.",
        "createdAt" : "2021-03-06T23:18:43Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "2399b093-02a5-4ccc-a531-052d2d3f2b5c",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "@viirya hmmm are you sure about it? AFAIK for operators like `Filter`, it doesn't evaluate all the child outputs, only the ones required by the condition, though `Filter.output` is `child.output`.",
        "createdAt" : "2021-03-08T09:04:50Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "a3ae9f6f-411f-4e3d-a496-3b8ca7689bcb",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "For Filter or Project, we do some evaluation deferring. Normally `CodegenSupport.usedInputs` is set to  `references`. `HashJoin` doesn't override it.",
        "createdAt" : "2021-03-08T09:25:45Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "c8499a63-a2dc-4af4-8ab2-a67a065367db",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "After a second check, I think we don't need to evaluate variable from stream side here, as `BroadcastNestedLoopJoinExec`'s stream child node should already have evaluated them in [consume()](https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/WholeStageCodegenExec.scala#L177) before calling `BroadcastNestedLoopJoinExec.doConsume()`. As @viirya pointed out, given `BroadcastNestedLoopJoinExec.usedInputs()` is `references`, it should contain all attributes of `condition` from stream side.\r\n\r\nThanks @viirya for pointing this out and careful review. @cloud-fan wondering what do you think?",
        "createdAt" : "2021-03-08T23:04:20Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      },
      {
        "id" : "c039f787-7d63-4cad-9d20-e067197d2875",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "ah, good catch! @viirya is right, we don't need to do that.",
        "createdAt" : "2021-03-09T05:29:49Z",
        "updatedAt" : "2021-03-09T06:31:40Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "211d9d05-0b4c-41ad-bab0-f67756544bdd",
        "parentId" : "137047c1-afb5-4586-a2db-794d2f4cc62c",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "Updated to evaluate build side only. Same as before in `HashJoin.scala`.",
        "createdAt" : "2021-03-09T06:32:07Z",
        "updatedAt" : "2021-03-09T06:32:07Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      }
    ],
    "commit" : "6f6d511e571a2109cba4dcd6b31fa3def4e44e21",
    "line" : 47,
    "diffHunk" : "@@ -1,1 +45,49 @@    val checkCondition = if (condition.isDefined) {\n      val expr = condition.get\n      // evaluate the variables from build side that used by condition\n      val eval = evaluateRequiredVariables(buildPlan.output, buildVars, expr.references)\n      // filter the output via condition"
  }
]