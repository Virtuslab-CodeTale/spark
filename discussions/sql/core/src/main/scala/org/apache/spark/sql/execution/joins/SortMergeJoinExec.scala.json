[
  {
    "id" : "c6185042-864d-477d-8903-a6bc4505c5c8",
    "prId" : 32547,
    "prUrl" : "https://github.com/apache/spark/pull/32547#pullrequestreview-669647084",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "1dbe8a08-0426-45b7-923c-e5e767a9bb4e",
        "parentId" : null,
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "nit: seems `loaded` is not needed for `LeftAnti` case.",
        "createdAt" : "2021-05-26T16:43:53Z",
        "updatedAt" : "2021-05-26T16:43:53Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "7eb993ff-7a84-4d0a-bc17-4d13264be58f",
        "parentId" : "1dbe8a08-0426-45b7-923c-e5e767a9bb4e",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "`loadStreamed` is not used by `LeftAnti`.\r\nI think you are referring to `boolean $loaded = false;` in `before` should not be needed, right?",
        "createdAt" : "2021-05-26T17:09:20Z",
        "updatedAt" : "2021-05-26T17:09:20Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      },
      {
        "id" : "06f43785-1cd7-40b1-b847-bfb56fc18d2f",
        "parentId" : "1dbe8a08-0426-45b7-923c-e5e767a9bb4e",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "yea, looks like for `LeftAnti`, it doesn't rely on `loaded` to do `streamedAfter`.",
        "createdAt" : "2021-05-26T17:47:24Z",
        "updatedAt" : "2021-05-26T17:47:24Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "601cd844-6737-4669-b85c-331a13d0e7cd",
        "parentId" : "1dbe8a08-0426-45b7-923c-e5e767a9bb4e",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "Created https://github.com/apache/spark/pull/32681 as followup, thanks.",
        "createdAt" : "2021-05-27T00:34:40Z",
        "updatedAt" : "2021-05-27T00:34:40Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      }
    ],
    "commit" : "df70b01c6c4c26be365f714b793c7e469e6ae1af",
    "line" : 93,
    "diffHunk" : "@@ -1,1 +694,698 @@           |  $streamedAfter\n           |}\n         \"\"\".stripMargin\n\n      val loadStreamedAfterCondition = joinType match {"
  },
  {
    "id" : "119c1636-8fc8-480f-97b2-499bc18179c8",
    "prId" : 32528,
    "prUrl" : "https://github.com/apache/spark/pull/32528#pullrequestreview-658744620",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "33d4eb5d-27c1-41c7-81e0-174c11cc4079",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "shall we pass `beforeLoop.trim` so that we don't need to do it in all the 3 methods?",
        "createdAt" : "2021-05-13T07:22:59Z",
        "updatedAt" : "2021-05-13T07:23:00Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "511fdee8-5434-48d8-b4fe-546cc9e340a2",
        "parentId" : "33d4eb5d-27c1-41c7-81e0-174c11cc4079",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "Actually after double checking, we do not need to do `beforeLoop.trim` as `beforeLoop` already has `stripMargin`, and has no trailing spaces. Also updated to avoid repeated `conditionCheck.trim`",
        "createdAt" : "2021-05-13T09:39:49Z",
        "updatedAt" : "2021-05-13T09:40:08Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      }
    ],
    "commit" : "6282a09d2b78aad102926f956a10d68272e05c8d",
    "line" : 229,
    "diffHunk" : "@@ -1,1 +722,726 @@    joinType match {\n      case _: InnerLike =>\n        codegenInner(findNextJoinRows, beforeLoop, iterator, bufferedRow, condCheck, outputRow,\n          eagerCleanup)\n      case LeftOuter | RightOuter =>"
  },
  {
    "id" : "b6884f8f-4895-4ce9-b3fd-e72ec59f6734",
    "prId" : 32528,
    "prUrl" : "https://github.com/apache/spark/pull/32528#pullrequestreview-658778708",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "04b29b37-59c3-4f62-b04e-710ff51088c3",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "do we need this flag if we are sure `matchIterator` has at most one element?",
        "createdAt" : "2021-05-13T07:24:48Z",
        "updatedAt" : "2021-05-13T07:24:49Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "eeb803c9-a1a8-4344-a2cf-2bf739c89074",
        "parentId" : "04b29b37-59c3-4f62-b04e-710ff51088c3",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "@cloud-fan - `matchIterator` will only has at most one element if join condition is empty. So yes we don't need this if join condition is empty. But consider the extra code is just a while loop check on `hasOutputRow`, and set value of `hasOutputRow`, I don't see much value to specialize another code-gen for left semi join without join condition. WDYT?",
        "createdAt" : "2021-05-13T08:19:10Z",
        "updatedAt" : "2021-05-13T08:19:15Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      },
      {
        "id" : "5f477737-ef19-49e3-972b-0c11397f58d5",
        "parentId" : "04b29b37-59c3-4f62-b04e-710ff51088c3",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "I see, let's keep it",
        "createdAt" : "2021-05-13T10:30:35Z",
        "updatedAt" : "2021-05-13T10:30:35Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "6282a09d2b78aad102926f956a10d68272e05c8d",
    "line" : 316,
    "diffHunk" : "@@ -1,1 +809,813 @@       |while ($findNextJoinRows) {\n       |  $beforeLoop\n       |  boolean $hasOutputRow = false;\n       |\n       |  while (!$hasOutputRow && $matchIterator.hasNext()) {"
  },
  {
    "id" : "68cfcebd-91ea-456a-b5db-f233c592e227",
    "prId" : 32495,
    "prUrl" : "https://github.com/apache/spark/pull/32495#pullrequestreview-659520578",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "076002f0-6a4a-4742-ad7a-e52da1088386",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "If we have multiple SMJ in one whole-stage, will we have multiple `findNextJoinRows` methods in the outer class and fail the compilation?",
        "createdAt" : "2021-05-13T13:51:56Z",
        "updatedAt" : "2021-05-13T13:51:56Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "eba09739-b74f-45ad-a439-dc691a55a41e",
        "parentId" : "076002f0-6a4a-4742-ad7a-e52da1088386",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "This is applying to inner join before this PR as well. There won't be an issue and we will never have multiple `findNextJoinRows` in one class. The reason is with current design, [sort merge join will always do code-gen for its children separately](https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/WholeStageCodegenExec.scala#L912), so there won't be two `SortMergeJoinExec`s code-gen-ed in the same class.\r\n\r\nVerified with example query:\r\n\r\n```\r\nval df1 = spark.range(10).select($\"id\".as(\"k1\"))\r\nval df2 = spark.range(4).select($\"id\".as(\"k2\"))\r\nval df3 = spark.range(6).select($\"id\".as(\"k3\"))\r\ndf3.join(df2.hint(\"SHUFFLE_MERGE\"), $\"k3\" === $\"k2\", \"left_outer\")\r\n  .join(df1.hint(\"SHUFFLE_MERGE\"), $\"k3\" === $\"k1\", \"right_outer\")\r\n  .explain(\"codegen\")\r\n```\r\n\r\nQuery plan:\r\n\r\n```\r\n*(8) SortMergeJoin [k3#10L], [k1#2L], RightOuter\r\n:- *(5) SortMergeJoin [k3#10L], [k2#6L], LeftOuter\r\n:  :- *(2) Sort [k3#10L ASC NULLS FIRST], false, 0\r\n:  :  +- Exchange hashpartitioning(k3#10L, 5), ENSURE_REQUIREMENTS, [id=#43]\r\n:  :     +- *(1) Project [id#8L AS k3#10L]\r\n:  :        +- *(1) Range (0, 6, step=1, splits=2)\r\n:  +- *(4) Sort [k2#6L ASC NULLS FIRST], false, 0\r\n:     +- Exchange hashpartitioning(k2#6L, 5), ENSURE_REQUIREMENTS, [id=#49]\r\n:        +- *(3) Project [id#4L AS k2#6L]\r\n:           +- *(3) Range (0, 4, step=1, splits=2)\r\n+- *(7) Sort [k1#2L ASC NULLS FIRST], false, 0\r\n   +- Exchange hashpartitioning(k1#2L, 5), ENSURE_REQUIREMENTS, [id=#58]\r\n      +- *(6) Project [id#0L AS k1#2L]\r\n         +- *(6) Range (0, 10, step=1, splits=2)\r\n```\r\n\r\nAll generated code is in https://gist.github.com/c21/873775bcd08583105b289e67221f6e17.",
        "createdAt" : "2021-05-13T23:29:41Z",
        "updatedAt" : "2021-05-13T23:29:42Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      },
      {
        "id" : "1b8f9469-3502-44be-b8b6-6723a2d9d609",
        "parentId" : "076002f0-6a4a-4742-ad7a-e52da1088386",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "got it, thanks!",
        "createdAt" : "2021-05-14T03:27:04Z",
        "updatedAt" : "2021-05-14T03:27:04Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "f17482ed-35b0-484b-88fc-a515bb0dd8e7",
        "parentId" : "076002f0-6a4a-4742-ad7a-e52da1088386",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "worth to add a comment for it, in case we changed this in the future (codegen one side with SMJ together)",
        "createdAt" : "2021-05-14T03:28:12Z",
        "updatedAt" : "2021-05-14T03:28:13Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "5c777c33-f53b-4fac-a069-bb41abbcfbe5",
        "parentId" : "076002f0-6a4a-4742-ad7a-e52da1088386",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "or we just make it future proof and create a fresh function name here.",
        "createdAt" : "2021-05-14T03:28:36Z",
        "updatedAt" : "2021-05-14T03:28:36Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "22231cf6-da4a-4c85-bdc2-23f188c9e750",
        "parentId" : "076002f0-6a4a-4742-ad7a-e52da1088386",
        "authorId" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "body" : "@cloud-fan - thanks for calling it out. I would like to make it future proof by giving it a fresh name. Let me do it in a followup PR. Actually I was wondering the same question as you when implementing and spent some time to figuring it out.",
        "createdAt" : "2021-05-14T05:05:58Z",
        "updatedAt" : "2021-05-14T05:05:58Z",
        "lastEditedBy" : "8df147d9-bc9d-4fd9-bb98-5dcf9619220b",
        "tags" : [
        ]
      }
    ],
    "commit" : "191243698d17978e1d4ed2bb966de2564926b309",
    "line" : 158,
    "diffHunk" : "@@ -1,1 +486,490 @@         |  return false; // unreachable\n         |}\n       \"\"\".stripMargin, inlineToOuterClass = true)\n\n    (streamedRow, matches)"
  }
]