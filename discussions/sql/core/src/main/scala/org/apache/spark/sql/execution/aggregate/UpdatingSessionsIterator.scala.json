[
  {
    "id" : "c2fe7733-4fd5-476b-847e-037a87b24a88",
    "prId" : 33081,
    "prUrl" : "https://github.com/apache/spark/pull/33081#pullrequestreview-692589086",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f90a1bf2-15e3-45ab-b6de-ed76c9421985",
        "parentId" : null,
        "authorId" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "body" : "There's a case session column is not placed at the end of the key. This line addresses such case.",
        "createdAt" : "2021-06-25T08:33:17Z",
        "updatedAt" : "2021-06-25T08:33:18Z",
        "lastEditedBy" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "tags" : [
        ]
      }
    ],
    "commit" : "bbade3501f16e9437ba9af4feca3e2029785d273",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +182,186 @@  private val valueProj = GenerateUnsafeProjection.generate(valuesExpressions, inputSchema)\n  private val restoreProj = GenerateUnsafeProjection.generate(inputSchema,\n    groupingWithoutSession.map(_.toAttribute) ++ Seq(sessionExpression.toAttribute) ++\n      valuesExpressions.map(_.toAttribute))\n"
  },
  {
    "id" : "a0403b5f-7146-42d4-b690-a0a751a553b3",
    "prId" : 33081,
    "prUrl" : "https://github.com/apache/spark/pull/33081#pullrequestreview-708099774",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "e7f9b944-d58f-4773-8f18-387d241efba3",
        "parentId" : null,
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "why adding this change?",
        "createdAt" : "2021-07-15T05:33:16Z",
        "updatedAt" : "2021-07-15T05:39:10Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "aa880cec-3464-433c-baf3-0d2483bb3a29",
        "parentId" : "e7f9b944-d58f-4773-8f18-387d241efba3",
        "authorId" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "body" : "I found some edge-case that the last two input rows close session. If that happens, `returnRowsIter` is not null in this method (that's why I removed assertion) and we have to append both iterators instead of simply replacing.\r\n\r\nThat's why I have to add `.copy()` in groupingKey as evaluation takes lazily and somehow two iterators would use same key which it shouldn't.",
        "createdAt" : "2021-07-15T07:39:42Z",
        "updatedAt" : "2021-07-15T07:39:42Z",
        "lastEditedBy" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "tags" : [
        ]
      },
      {
        "id" : "ac775740-f110-4dca-99b8-2683cb486073",
        "parentId" : "e7f9b944-d58f-4773-8f18-387d241efba3",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "Have you added corresponding test for the edge cases?",
        "createdAt" : "2021-07-16T07:50:06Z",
        "updatedAt" : "2021-07-16T07:50:06Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "bbade3501f16e9437ba9af4feca3e2029785d273",
    "line" : 32,
    "diffHunk" : "@@ -1,1 +206,210 @@    } else {\n      returnRowsIter = currentRowsIter\n    }\n\n    if (keyChanged) processedKeys.add(currentKeys)"
  },
  {
    "id" : "dcf77863-d30f-4204-a73e-ec5143008f21",
    "prId" : 31986,
    "prUrl" : "https://github.com/apache/spark/pull/31986#pullrequestreview-644210529",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "5d7d0a6c-3cbe-4907-be74-4abf7551f343",
        "parentId" : null,
        "authorId" : "cd38bd5a-0fae-4d8e-8acd-36dc13753759",
        "body" : "Not sure the var `errorOnIterator` is necessary or not, since we throw an exception just after it turns to `true`.",
        "createdAt" : "2021-04-21T13:07:21Z",
        "updatedAt" : "2021-05-11T04:07:22Z",
        "lastEditedBy" : "cd38bd5a-0fae-4d8e-8acd-36dc13753759",
        "tags" : [
        ]
      },
      {
        "id" : "74c47b62-63ce-48a2-8c9e-17f0c6aa71d8",
        "parentId" : "5d7d0a6c-3cbe-4907-be74-4abf7551f343",
        "authorId" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "body" : "This ensures the iterator won't work \"after\" raising exception. The iterator itself should make sense without any context how Spark works.",
        "createdAt" : "2021-04-26T01:29:50Z",
        "updatedAt" : "2021-05-11T04:07:22Z",
        "lastEditedBy" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "tags" : [
        ]
      }
    ],
    "commit" : "8c2eed82d553ddacb36088954232ae704a855094",
    "line" : 175,
    "diffHunk" : "@@ -1,1 +173,177 @@\n  private def handleBrokenPreconditionForSort(): Unit = {\n    errorOnIterator = true\n    throw new IllegalStateException(\"The iterator must be sorted by key and session start!\")\n  }"
  },
  {
    "id" : "5e54f651-1c44-4b97-a7f6-c027b3bccacb",
    "prId" : 31986,
    "prUrl" : "https://github.com/apache/spark/pull/31986#pullrequestreview-644397778",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "adeac8d8-ce20-43fb-aa19-8daca437fa7f",
        "parentId" : null,
        "authorId" : "cd38bd5a-0fae-4d8e-8acd-36dc13753759",
        "body" : "Spend some time reviewing all the vars. It would be great to add some comment on each variable?",
        "createdAt" : "2021-04-21T13:24:17Z",
        "updatedAt" : "2021-05-11T04:07:22Z",
        "lastEditedBy" : "cd38bd5a-0fae-4d8e-8acd-36dc13753759",
        "tags" : [
        ]
      },
      {
        "id" : "b08946f7-ded6-46ef-b8ba-202be81eb75b",
        "parentId" : "adeac8d8-ce20-43fb-aa19-8daca437fa7f",
        "authorId" : "cd38bd5a-0fae-4d8e-8acd-36dc13753759",
        "body" : "Or rename some vars, e.g. `currentRows` -> `rowsForCurrentSession`?",
        "createdAt" : "2021-04-21T13:26:02Z",
        "updatedAt" : "2021-05-11T04:07:22Z",
        "lastEditedBy" : "cd38bd5a-0fae-4d8e-8acd-36dc13753759",
        "tags" : [
        ]
      },
      {
        "id" : "09fce272-8e20-4a92-b339-434fbc795fcd",
        "parentId" : "adeac8d8-ce20-43fb-aa19-8daca437fa7f",
        "authorId" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "body" : "Changed variable names, as well as added some information on variables.",
        "createdAt" : "2021-04-26T08:29:47Z",
        "updatedAt" : "2021-05-11T04:07:22Z",
        "lastEditedBy" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "tags" : [
        ]
      }
    ],
    "commit" : "8c2eed82d553ddacb36088954232ae704a855094",
    "line" : 58,
    "diffHunk" : "@@ -1,1 +56,60 @@\n  // Below three variables hold the information for \"current session\".\n  private var currentKeys: InternalRow = _\n  private var currentSession: UnsafeRow = _\n  private var rowsForCurrentSession: ExternalAppendOnlyUnsafeRowArray = _"
  },
  {
    "id" : "e934d4f2-3e03-414b-960a-47592e01fc29",
    "prId" : 31986,
    "prUrl" : "https://github.com/apache/spark/pull/31986#pullrequestreview-656213644",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "56faf5da-c720-4b15-8022-f052c7d01ac9",
        "parentId" : null,
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "session gap is already added to session end?",
        "createdAt" : "2021-05-11T01:13:59Z",
        "updatedAt" : "2021-05-11T04:07:22Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "bd543f1d-2935-43cc-83d6-125345e7acce",
        "parentId" : "56faf5da-c720-4b15-8022-f052c7d01ac9",
        "authorId" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "body" : "Yes, every row has session end which session gap is applied. Merging sessions would expand session end as later one which session gap is applied.",
        "createdAt" : "2021-05-11T01:44:04Z",
        "updatedAt" : "2021-05-11T04:07:22Z",
        "lastEditedBy" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "tags" : [
        ]
      }
    ],
    "commit" : "8c2eed82d553ddacb36088954232ae704a855094",
    "line" : 125,
    "diffHunk" : "@@ -1,1 +123,127 @@          closeCurrentSession(keyChanged = false)\n          startNewSession(row, keys, sessionStruct)\n          exitCondition = true\n        }\n      }"
  },
  {
    "id" : "82bac9be-d050-4c4e-80d2-b19b0ffed40d",
    "prId" : 31986,
    "prUrl" : "https://github.com/apache/spark/pull/31986#pullrequestreview-656213644",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "fc44369f-56f9-44e1-8ec4-7f42fac503e1",
        "parentId" : null,
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "The projection of `groupingKey` looks redundant? Looks like we only need do `restoreProj`?",
        "createdAt" : "2021-05-11T01:23:22Z",
        "updatedAt" : "2021-05-11T04:07:22Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "e832c5ad-29c5-41de-b45b-9af3df4eb9a9",
        "parentId" : "fc44369f-56f9-44e1-8ec4-7f42fac503e1",
        "authorId" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "body" : "Yeah just removed the projection of groupingKeys. Just needed to join the rows. Thanks!",
        "createdAt" : "2021-05-11T03:43:44Z",
        "updatedAt" : "2021-05-11T04:07:22Z",
        "lastEditedBy" : "0c28e5da-df9b-4076-bb67-3b6878f1f4ce",
        "tags" : [
        ]
      }
    ],
    "commit" : "8c2eed82d553ddacb36088954232ae704a855094",
    "line" : 202,
    "diffHunk" : "@@ -1,1 +200,204 @@    val currentRowsIter = returnRows.generateIterator().map { internalRow =>\n      val valueRow = valueProj(internalRow)\n      restoreProj(join2(groupingKey, valueRow)).copy()\n    }\n"
  }
]