[
  {
    "id" : "459db4eb-f306-4e12-8649-bed2a80ee472",
    "prId" : 33655,
    "prUrl" : "https://github.com/apache/spark/pull/33655#pullrequestreview-723532662",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "4eb25cc3-e751-4e46-b80a-dc288dc33e46",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "a small cleanup",
        "createdAt" : "2021-08-05T15:57:02Z",
        "updatedAt" : "2021-08-05T15:57:02Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "eeeff3ae6bb62eedeb09011cc99514d240a8b7d0",
    "line" : 12,
    "diffHunk" : "@@ -1,1 +58,62 @@    val totalPostShuffleInputSize = mapOutputStatistics.flatMap(_.map(_.bytesByPartitionId.sum)).sum\n    val maxTargetSize = math.ceil(totalPostShuffleInputSize / minNumPartitions.toDouble).toLong\n    // It's meaningless to make target size smaller than minPartitionSize.\n    val targetSize = maxTargetSize.min(advisoryTargetSize).max(minPartitionSize)\n"
  },
  {
    "id" : "d1ae489a-0d38-43bc-831c-1bc4729cbc96",
    "prId" : 33172,
    "prUrl" : "https://github.com/apache/spark/pull/33172#pullrequestreview-697052590",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "4af63f40-c370-4b0e-9098-fca00bcb8ef0",
        "parentId" : null,
        "authorId" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "body" : "shall we mention the minPartitionSize here?",
        "createdAt" : "2021-07-01T09:39:46Z",
        "updatedAt" : "2021-07-01T09:39:47Z",
        "lastEditedBy" : "c62ded40-3015-4888-8e91-d671d0f615be",
        "tags" : [
        ]
      },
      {
        "id" : "ea467fdc-22f9-405c-956e-781d8df6b9bb",
        "parentId" : "4af63f40-c370-4b0e-9098-fca00bcb8ef0",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "sure",
        "createdAt" : "2021-07-01T09:56:05Z",
        "updatedAt" : "2021-07-01T09:56:05Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "51546e87c33064c80f902d4eecff1f640222dfb2",
    "line" : 13,
    "diffHunk" : "@@ -1,1 +66,70 @@\n    val shuffleIds = mapOutputStatistics.flatMap(_.map(_.shuffleId)).mkString(\", \")\n    logInfo(s\"For shuffle($shuffleIds), advisory target size: $advisoryTargetSize, \" +\n      s\"actual target size $targetSize, minimum partition size: $minPartitionSize\")\n"
  },
  {
    "id" : "4cc9b1cb-fed4-44a4-b28f-a12f3825cb74",
    "prId" : 33123,
    "prUrl" : "https://github.com/apache/spark/pull/33123#pullrequestreview-695129146",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "07c83502-aa8d-4bf4-87bd-c6fff2037e3f",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "How do we make sure we return at least one partition spec if there is no skew partition spec?",
        "createdAt" : "2021-06-29T14:10:30Z",
        "updatedAt" : "2021-06-29T14:10:30Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "50f5eb73-8d57-48b2-9aa0-180035c27102",
        "parentId" : "07c83502-aa8d-4bf4-87bd-c6fff2037e3f",
        "authorId" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "body" : "this code is under `coalescePartitionsWithSkew` which must have some skew partition specs",
        "createdAt" : "2021-06-29T14:40:23Z",
        "updatedAt" : "2021-06-29T14:40:23Z",
        "lastEditedBy" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "tags" : [
        ]
      }
    ],
    "commit" : "ed4e07f85655443f800b20995fbf6237cd719552",
    "line" : 16,
    "diffHunk" : "@@ -1,1 +175,179 @@        partitionIndices(start), partitionIndices.last + 1, validMetrics, targetSize, true)\n      newPartitionSpecsSeq.zip(partitionSpecs).foreach(spec => spec._1 ++= spec._2)\n    }\n    // only return coalesced result if any coalescing has happened.\n    if (newPartitionSpecsSeq.head.length < numPartitions) {"
  },
  {
    "id" : "73faffab-e89e-4028-bee3-b95b7c9d4b8c",
    "prId" : 32883,
    "prUrl" : "https://github.com/apache/spark/pull/32883#pullrequestreview-694621117",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "8d7dbe02-3053-42af-a195-5cf32b543775",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "Are these new methods exactly the same as the removed ones in `OptimizeSkewedJoin`?",
        "createdAt" : "2021-06-29T04:30:31Z",
        "updatedAt" : "2021-06-29T04:30:31Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "9853ef15-7cc3-4732-9383-a738922038c5",
        "parentId" : "8d7dbe02-3053-42af-a195-5cf32b543775",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "and do all the methods need to be public?",
        "createdAt" : "2021-06-29T04:34:09Z",
        "updatedAt" : "2021-06-29T04:34:09Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "5c7f6cbd-e151-422b-a5a3-b372e0b024c3",
        "parentId" : "8d7dbe02-3053-42af-a195-5cf32b543775",
        "authorId" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "body" : "they are same with a little change `ShufflePartitionsUtil.splitSizeListByTargetSize` -> `splitSizeListByTargetSize`. \r\n\r\nupdated the method scope",
        "createdAt" : "2021-06-29T06:06:07Z",
        "updatedAt" : "2021-06-29T06:06:07Z",
        "lastEditedBy" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "tags" : [
        ]
      }
    ],
    "commit" : "8e706ae5f289ce9d4f6a7ca624f1d58516a8a177",
    "line" : 24,
    "diffHunk" : "@@ -1,1 +311,315 @@  }\n\n  /**\n   * Get the map size of the specific reduce shuffle Id.\n   */"
  },
  {
    "id" : "64601b05-0d04-4252-9348-79e1768ef7ae",
    "prId" : 32594,
    "prUrl" : "https://github.com/apache/spark/pull/32594#pullrequestreview-666595997",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "1650d347-6d4b-494e-9fc3-7030893eb54e",
        "parentId" : null,
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "The logic assumes the indices increase monotonically, too?",
        "createdAt" : "2021-05-23T13:10:31Z",
        "updatedAt" : "2021-05-23T14:00:43Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "d131da2c-522c-45f9-952b-edaec4202eaa",
        "parentId" : "1650d347-6d4b-494e-9fc3-7030893eb54e",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "Yes, which is ensured by the while loop below.",
        "createdAt" : "2021-05-24T10:14:48Z",
        "updatedAt" : "2021-05-24T10:15:31Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "fa0065be21e1cd36b40fb76447c2701a74326517",
    "line" : 113,
    "diffHunk" : "@@ -1,1 +127,131 @@    // There should be no unexpected partition specs and the start indices should be identical\n    // across all different shuffles.\n    assert(partitionIndicesSeq.distinct.length == 1 && partitionIndicesSeq.head.forall(_ >= 0),\n      s\"Invalid shuffle partition specs: $inputPartitionSpecs\")\n"
  },
  {
    "id" : "9b858453-e93f-4762-a3ce-7cf3f225ec3d",
    "prId" : 32594,
    "prUrl" : "https://github.com/apache/spark/pull/32594#pullrequestreview-666604083",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "9f0a4d09-ffac-4132-93ce-d9139360263e",
        "parentId" : null,
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "it seems `ShufflePartitionsUtilSuite` doesn't have a test for the case where no coalescing happens.",
        "createdAt" : "2021-05-23T13:14:14Z",
        "updatedAt" : "2021-05-23T14:00:43Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "c2b5a642-49b4-4a52-a248-efc792d5bee0",
        "parentId" : "9f0a4d09-ffac-4132-93ce-d9139360263e",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "test added",
        "createdAt" : "2021-05-24T10:26:25Z",
        "updatedAt" : "2021-05-24T10:26:25Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "fa0065be21e1cd36b40fb76447c2701a74326517",
    "line" : 165,
    "diffHunk" : "@@ -1,1 +179,183 @@      newPartitionSpecsSeq.map(_.toSeq)\n    } else {\n      Seq.empty\n    }\n  }"
  },
  {
    "id" : "b682c3e1-ccbc-41bf-be00-819f723ed938",
    "prId" : 32594,
    "prUrl" : "https://github.com/apache/spark/pull/32594#pullrequestreview-666569237",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "ab581db3-5cc6-4964-860d-32807c021ce7",
        "parentId" : null,
        "authorId" : "1b84a7ff-6bf9-4417-bf9f-e46e997e5974",
        "body" : "It is better to move this check in the beginning of this method.",
        "createdAt" : "2021-05-24T03:25:20Z",
        "updatedAt" : "2021-05-24T03:26:39Z",
        "lastEditedBy" : "1b84a7ff-6bf9-4417-bf9f-e46e997e5974",
        "tags" : [
        ]
      },
      {
        "id" : "d9cbf648-ad5f-442d-9a37-e79d2ef80a33",
        "parentId" : "ab581db3-5cc6-4964-860d-32807c021ce7",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "We can't as this check only applies if skew join optimization happens first.",
        "createdAt" : "2021-05-24T09:40:15Z",
        "updatedAt" : "2021-05-24T09:40:15Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "fa0065be21e1cd36b40fb76447c2701a74326517",
    "line" : 96,
    "diffHunk" : "@@ -1,1 +110,114 @@    // Do not coalesce if any of the map output stats are missing or if not all shuffles have\n    // partition specs, which should not happen in practice.\n    if (!mapOutputStatistics.forall(_.isDefined) || !inputPartitionSpecs.forall(_.isDefined)) {\n      logWarning(\"Could not apply partition coalescing because of missing MapOutputStatistics \" +\n        \"or shuffle partition specs.\")"
  },
  {
    "id" : "97a887cb-d31e-4d78-8e6f-6e49507f05bd",
    "prId" : 32594,
    "prUrl" : "https://github.com/apache/spark/pull/32594#pullrequestreview-666605585",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "54abb706-8ca3-486b-935b-c8dbb8d9762f",
        "parentId" : null,
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "I think the following only does \"coalesce any partitions before partition(i - 1)\" but not \"after the end of latest skew section\"? ",
        "createdAt" : "2021-05-24T05:16:32Z",
        "updatedAt" : "2021-05-24T05:16:47Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "50c6bf73-19b0-4f2a-bbbf-6ad5c05cc4e3",
        "parentId" : "54abb706-8ca3-486b-935b-c8dbb8d9762f",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "`start` will be set to the end of the latest skew section.",
        "createdAt" : "2021-05-24T10:28:34Z",
        "updatedAt" : "2021-05-24T10:28:34Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "fa0065be21e1cd36b40fb76447c2701a74326517",
    "line" : 130,
    "diffHunk" : "@@ -1,1 +144,148 @@        // a skew section detected, starting from partition(i - 1).\n        val repeatValue = partitionIndices(i)\n        // coalesce any partitions before partition(i - 1) and after the end of latest skew section.\n        if (i - 1 > start) {\n          val partitionSpecs = coalescePartitions("
  },
  {
    "id" : "74be09ca-9311-41c5-a365-60e6fc828d36",
    "prId" : 32594,
    "prUrl" : "https://github.com/apache/spark/pull/32594#pullrequestreview-727054508",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "64ad10c4-7ed8-4747-bf06-505e8386e9e1",
        "parentId" : null,
        "authorId" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "body" : "@cloud-fan  I see this code is not from this PR, but seems use the sum value of all shuffle map output statistics is not friendly for `Union`.",
        "createdAt" : "2021-08-11T01:57:29Z",
        "updatedAt" : "2021-08-11T01:57:29Z",
        "lastEditedBy" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "tags" : [
        ]
      },
      {
        "id" : "43f928fd-1f1c-4b0c-9759-49aa06084880",
        "parentId" : "64ad10c4-7ed8-4747-bf06-505e8386e9e1",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "We need a better algorithm to do partition coalescing, which considers different operators (Union vs Join for example)",
        "createdAt" : "2021-08-11T05:27:35Z",
        "updatedAt" : "2021-08-11T05:27:35Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "fa0065be21e1cd36b40fb76447c2701a74326517",
    "line" : 41,
    "diffHunk" : "@@ -1,1 +55,59 @@    // If `minNumPartitions` is very large, it is possible that we need to use a value less than\n    // `advisoryTargetSize` as the target size of a coalesced task.\n    val totalPostShuffleInputSize = mapOutputStatistics.flatMap(_.map(_.bytesByPartitionId.sum)).sum\n    // The max at here is to make sure that when we have an empty table, we only have a single\n    // coalesced partition."
  }
]