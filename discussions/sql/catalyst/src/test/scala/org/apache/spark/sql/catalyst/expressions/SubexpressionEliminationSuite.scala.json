[
  {
    "id" : "14292725-0c1f-4bb3-b3c0-e5fca45cf015",
    "prId" : 33142,
    "prUrl" : "https://github.com/apache/spark/pull/33142#pullrequestreview-696772027",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "86778037-56f9-47d9-8ee2-1ffeec06d9c3",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "The changes in this file is to adapt the new API in `EquivalentExpressions`. e.g.\r\n`getAllEquivalentExprs()` -> `getAllExprStates`\r\n`getEquivalentExprs(oneA).size == 1` -> `getExprState(oneA).get.useCount == 1`\r\n`getEquivalentExprs(oneA).exists(_ eq oneA)` -> `getExprState(oneA).exists(_.expr eq oneA)`",
        "createdAt" : "2021-07-01T03:10:48Z",
        "updatedAt" : "2021-07-01T03:10:48Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "92786a625a7288edf93479f0615bd77a254f589b",
    "line" : 1,
    "diffHunk" : "@@ -1,1 +45,49 @@    assert(a.semanticEquals(b3))\n  }\n\n  test(\"Expression Equivalence - basic\") {\n    val equivalence = new EquivalentExpressions"
  },
  {
    "id" : "0ed1e4d5-3a17-4ff8-9fb2-1426c1b8bd0f",
    "prId" : 32559,
    "prUrl" : "https://github.com/apache/spark/pull/32559#pullrequestreview-663582769",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "b283abbc-0049-4ba2-91d2-b785d033dbaa",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "is this only a problem for conditional expression?",
        "createdAt" : "2021-05-17T14:37:17Z",
        "updatedAt" : "2021-05-17T14:37:17Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "b168f42f-888c-4df2-8434-6db13318729c",
        "parentId" : "b283abbc-0049-4ba2-91d2-b785d033dbaa",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "So far the only one I can think about.",
        "createdAt" : "2021-05-17T16:23:54Z",
        "updatedAt" : "2021-05-17T16:23:54Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "27e4101b-cb33-4920-80fb-7ce81d419a71",
        "parentId" : "b283abbc-0049-4ba2-91d2-b785d033dbaa",
        "authorId" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "body" : "Found a non-conditional example that still is an issue even with this update (a bit contrived, but I'm sure there's a real use case)\r\n\r\n```\r\nval myUdf = udf(() => {\r\n  println(\"In UDF\")\r\n  1\r\n}).withName(\"myUdf\")\r\nspark.range(1).withColumn(\"a\", myUdf()).select(($\"a\" + $\"a\") / ($\"a\" + $\"a\")).show()\r\n```\r\nThis generates subexpressions myUdf() and (myUdf() + myUdf()), even though only the second one is used.\r\n",
        "createdAt" : "2021-05-17T22:37:58Z",
        "updatedAt" : "2021-05-17T22:37:58Z",
        "lastEditedBy" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "tags" : [
        ]
      },
      {
        "id" : "7d977e0a-5fdf-4d62-bb67-9b7a8e93ac1c",
        "parentId" : "b283abbc-0049-4ba2-91d2-b785d033dbaa",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "Thanks @Kimahriman. I see. Let me also look at it. As it is non-conditional case, but looks like the similar case. Let me see if it can be solved similarly.",
        "createdAt" : "2021-05-17T22:51:15Z",
        "updatedAt" : "2021-05-17T22:51:15Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "c03f6edf-14d8-40de-8c4f-96be67df1b62",
        "parentId" : "b283abbc-0049-4ba2-91d2-b785d033dbaa",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "Oh, I figured out. This might be an issue since we have sub-expr elimination. We also need to remove redundant children exprs for non-conditional cases.",
        "createdAt" : "2021-05-18T02:27:57Z",
        "updatedAt" : "2021-05-18T02:27:57Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "e4311b85-4d54-4e89-82cf-addc03bc3bd7",
        "parentId" : "b283abbc-0049-4ba2-91d2-b785d033dbaa",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "But the fix might be different. I will work on it locally and submit another fix for it.",
        "createdAt" : "2021-05-18T02:29:44Z",
        "updatedAt" : "2021-05-18T02:29:44Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "29c38fb9-9b0e-47c1-9fdb-a45beb71f6f9",
        "parentId" : "b283abbc-0049-4ba2-91d2-b785d033dbaa",
        "authorId" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "body" : "Any more thoughts on this? Was the subexpr sorting supposed to address this?",
        "createdAt" : "2021-05-19T19:15:25Z",
        "updatedAt" : "2021-05-19T19:15:25Z",
        "lastEditedBy" : "92aa9573-b64a-4a86-aebf-54c827df3ed0",
        "tags" : [
        ]
      },
      {
        "id" : "4dc7c421-b2b7-44d7-9c98-fd10c65c4ede",
        "parentId" : "b283abbc-0049-4ba2-91d2-b785d033dbaa",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "It might need another fix. I'm working on it and will submit it after these PRs merged.",
        "createdAt" : "2021-05-19T19:26:25Z",
        "updatedAt" : "2021-05-19T19:26:25Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "9973c1a4d6bbaa089b120e47a8418e99b132704d",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +312,316 @@\n  test(\"SPARK-35410: SubExpr elimination should not include redundant child exprs \" +\n    \"for conditional expressions\") {\n    val add1 = Add(Literal(1), Literal(2))\n    val add2 = Add(Literal(2), Literal(3))"
  },
  {
    "id" : "07168c9d-936f-49b0-ae10-1389f1287bea",
    "prId" : 30245,
    "prUrl" : "https://github.com/apache/spark/pull/30245#pullrequestreview-523070819",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "82bdb502-60fc-4a2b-8f0f-fb5f460264ed",
        "parentId" : null,
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "I will add the tests for `CaseWhen` and `Coalesce`, but the idea is the same.",
        "createdAt" : "2020-11-04T06:25:43Z",
        "updatedAt" : "2020-11-10T05:20:11Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "b41572884401d5e02d6cda69068433376c6ab328",
    "line" : 10,
    "diffHunk" : "@@ -1,1 +150,154 @@  }\n\n  test(\"Children of conditional expressions: If\") {\n    val add = Add(Literal(1), Literal(2))\n    val condition = GreaterThan(add, Literal(3))"
  },
  {
    "id" : "595ceb54-3874-440f-adfe-fb07887c89fe",
    "prId" : 30245,
    "prUrl" : "https://github.com/apache/spark/pull/30245#pullrequestreview-526856431",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "e2eb6ebd-4163-4109-a1ff-8413803b0d6b",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "`add1` is also repeated. Why it's not included?",
        "createdAt" : "2020-11-10T04:59:55Z",
        "updatedAt" : "2020-11-10T05:20:11Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "e8537d35-9517-41ff-aa24-b2f047ae77a2",
        "parentId" : "e2eb6ebd-4163-4109-a1ff-8413803b0d6b",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "We treat the first condition specially because it is definitely run. So it counts one for `add2`.  Other conditions all contain `add2` so it counts for one. That is where the count 2 comes from for `add2`.\r\n\r\nFor `add1`, although all values contain it, it is definitely run, so we count it one. If no other expression contains `add1`, we don't extract subexpression for `add1` as it will run just once (we only run one value of `CaseWhen`).",
        "createdAt" : "2020-11-10T05:08:20Z",
        "updatedAt" : "2020-11-10T05:20:11Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "b41572884401d5e02d6cda69068433376c6ab328",
    "line" : 67,
    "diffHunk" : "@@ -1,1 +200,204 @@    equivalence1.addExprTree(caseWhenExpr1)\n\n    // `add2` is repeatedly in all conditions.\n    assert(equivalence1.getAllEquivalentExprs.count(_.size == 2) == 1)\n    assert(equivalence1.getAllEquivalentExprs.filter(_.size == 2).head == Seq(add2, add2))"
  },
  {
    "id" : "6409ed57-5973-4095-ad71-8d09aa28a694",
    "prId" : 30245,
    "prUrl" : "https://github.com/apache/spark/pull/30245#pullrequestreview-530475980",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "b08b58a3-e9b9-49f9-8f05-6616945bcccf",
        "parentId" : null,
        "authorId" : "7f1185d9-3900-4812-b576-80ba5f410d6b",
        "body" : "Should we use contains method? HashMap can not guarantee the order",
        "createdAt" : "2020-11-12T01:18:24Z",
        "updatedAt" : "2020-11-12T01:18:24Z",
        "lastEditedBy" : "7f1185d9-3900-4812-b576-80ba5f410d6b",
        "tags" : [
        ]
      },
      {
        "id" : "bd60fe9c-24b0-44ae-b2c6-9b24570a7499",
        "parentId" : "b08b58a3-e9b9-49f9-8f05-6616945bcccf",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "Ok, I will create a follow-up for making sure it will not possibly flaky. Thanks.",
        "createdAt" : "2020-11-12T01:53:07Z",
        "updatedAt" : "2020-11-12T01:53:07Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "e7762efe-79b5-4076-a8d5-dd431e67bdca",
        "parentId" : "b08b58a3-e9b9-49f9-8f05-6616945bcccf",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "Created #30371.",
        "createdAt" : "2020-11-13T20:32:50Z",
        "updatedAt" : "2020-11-13T20:32:51Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "42add879-8fee-438a-98f6-2de9662f3dea",
        "parentId" : "b08b58a3-e9b9-49f9-8f05-6616945bcccf",
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "Thank you, @leoluan2009 and @viirya . The follow-up is merged to reduce the flakiness.",
        "createdAt" : "2020-11-13T23:21:52Z",
        "updatedAt" : "2020-11-13T23:21:52Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      }
    ],
    "commit" : "b41572884401d5e02d6cda69068433376c6ab328",
    "line" : 30,
    "diffHunk" : "@@ -1,1 +163,167 @@    // one-time expressions: only ifExpr and its predicate expression\n    assert(equivalence1.getAllEquivalentExprs.count(_.size == 1) == 2)\n    assert(equivalence1.getAllEquivalentExprs.filter(_.size == 1).head == Seq(ifExpr1))\n    assert(equivalence1.getAllEquivalentExprs.filter(_.size == 1).last == Seq(condition))\n"
  }
]