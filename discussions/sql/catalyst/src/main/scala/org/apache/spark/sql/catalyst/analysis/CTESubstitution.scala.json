[
  {
    "id" : "7b064783-0c22-42de-ac61-59add1eea324",
    "prId" : 33671,
    "prUrl" : "https://github.com/apache/spark/pull/33671#pullrequestreview-727631385",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "e378dbb2-e018-4bff-a2e6-cc88357b4f4f",
        "parentId" : null,
        "authorId" : "8c82da5a-f351-4a37-a8a9-13809311b07b",
        "body" : "`plan.collectFirst` would be quicker and less memory-hungry, wouldn't it?",
        "createdAt" : "2021-08-11T14:42:24Z",
        "updatedAt" : "2021-08-11T14:46:43Z",
        "lastEditedBy" : "8c82da5a-f351-4a37-a8a9-13809311b07b",
        "tags" : [
        ]
      },
      {
        "id" : "06615c77-e8a1-41de-b5a8-ff09722e3baf",
        "parentId" : "e378dbb2-e018-4bff-a2e6-cc88357b4f4f",
        "authorId" : "4916859c-0e27-4e9d-ac39-ad95bc1382d3",
        "body" : "Maybe I'm missing sth, but I don't see how so.",
        "createdAt" : "2021-08-11T15:26:07Z",
        "updatedAt" : "2021-08-11T15:26:07Z",
        "lastEditedBy" : "4916859c-0e27-4e9d-ac39-ad95bc1382d3",
        "tags" : [
        ]
      }
    ],
    "commit" : "4cc52f74ab8a12599b74ae163e8f4065a99e359d",
    "line" : 42,
    "diffHunk" : "@@ -1,1 +49,53 @@object CTESubstitution extends Rule[LogicalPlan] {\n  def apply(plan: LogicalPlan): LogicalPlan = {\n    val isCommand = plan.find {\n      case _: Command | _: ParsedStatement | _: InsertIntoDir => true\n      case _ => false"
  },
  {
    "id" : "524d8d14-b2ed-4753-be8c-a70225210d68",
    "prId" : 33671,
    "prUrl" : "https://github.com/apache/spark/pull/33671#pullrequestreview-731817751",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "107615de-c197-46f2-be00-2f7a8ac2ad53",
        "parentId" : null,
        "authorId" : "3d4870da-39a8-4406-b00d-131930d14cd8",
        "body" : "As the return value of `traverseAndSubstituteCTE` changed a bit, this docs could use some update.",
        "createdAt" : "2021-08-17T14:09:24Z",
        "updatedAt" : "2021-08-17T14:09:24Z",
        "lastEditedBy" : "3d4870da-39a8-4406-b00d-131930d14cd8",
        "tags" : [
        ]
      }
    ],
    "commit" : "4cc52f74ab8a12599b74ae163e8f4065a99e359d",
    "line" : 110,
    "diffHunk" : "@@ -1,1 +168,172 @@   *   )\n   * @param plan the plan to be traversed\n   * @return the plan where CTE substitution is applied\n   */\n  private def traverseAndSubstituteCTE("
  },
  {
    "id" : "a1792865-0bd5-4f25-bd40-cb82c45ae91f",
    "prId" : 28407,
    "prUrl" : "https://github.com/apache/spark/pull/28407#pullrequestreview-403359701",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "9f38d08f-d71a-4d88-8a9a-e8e4a07d1a94",
        "parentId" : null,
        "authorId" : "a2fcc15e-a51a-42f0-87a6-137048a28e30",
        "body" : "@cloud-fan Just trying to understand. innerCTEResolved indicates a already resolved CTE or the one we are going to resolve in the subsequent call to substituteCTE ?",
        "createdAt" : "2020-04-30T07:29:45Z",
        "updatedAt" : "2020-04-30T09:20:01Z",
        "lastEditedBy" : "a2fcc15e-a51a-42f0-87a6-137048a28e30",
        "tags" : [
        ]
      },
      {
        "id" : "a2e60535-8431-4e7a-94d7-b881cce8d889",
        "parentId" : "9f38d08f-d71a-4d88-8a9a-e8e4a07d1a94",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "\"resolved\" here means the `With` is resolved inside this relation. The relation needs further processing to substitute `UnresolvedRelation` with the previous CTE relations.\r\n\r\nThe naming is not very accurate when `legacy = true`, but this probably doesn't matter.",
        "createdAt" : "2020-04-30T09:09:37Z",
        "updatedAt" : "2020-04-30T12:09:57Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "f7bb0a0f-fedb-4965-bd00-29492b7d8b0a",
        "parentId" : "9f38d08f-d71a-4d88-8a9a-e8e4a07d1a94",
        "authorId" : "a2fcc15e-a51a-42f0-87a6-137048a28e30",
        "body" : "@cloud-fan OK. sounds good.",
        "createdAt" : "2020-04-30T09:38:46Z",
        "updatedAt" : "2020-04-30T09:38:46Z",
        "lastEditedBy" : "a2fcc15e-a51a-42f0-87a6-137048a28e30",
        "tags" : [
        ]
      }
    ],
    "commit" : "b022e3513a842329b24569840a07a501bed9a188",
    "line" : 44,
    "diffHunk" : "@@ -1,1 +152,156 @@    val resolvedCTERelations = new mutable.ArrayBuffer[(String, LogicalPlan)](relations.size)\n    for ((name, relation) <- relations) {\n      val innerCTEResolved = if (isLegacy) {\n        // In legacy mode, outer CTE relations take precedence. Here we don't resolve the inner\n        // `With` nodes, later we will substitute `UnresolvedRelation`s with outer CTE relations."
  },
  {
    "id" : "11f0251c-006c-49f4-97dd-512ae42cfec2",
    "prId" : 28407,
    "prUrl" : "https://github.com/apache/spark/pull/28407#pullrequestreview-403323467",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "32cf7bb3-10c6-4fbb-95f4-4629f0ca5863",
        "parentId" : null,
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "For legacy case, `innerCTEResolved` might contain an inner `WITH`, but seems `substituteCTE` doesn't remove `WITH`.\r\n\r\nThen in later `substituteCTE`s, will we result some untouched `WITH`s in the final query plan ?\r\n\r\n\r\n\r\n\r\n\r\n",
        "createdAt" : "2020-04-30T07:57:27Z",
        "updatedAt" : "2020-04-30T09:20:01Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "3786d1a6-c744-4d8d-bd01-48f6d5c5aeb9",
        "parentId" : "32cf7bb3-10c6-4fbb-95f4-4629f0ca5863",
        "authorId" : "3d4870da-39a8-4406-b00d-131930d14cd8",
        "body" : "The rule `CTESubstitution` runs in a batch many times (https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/Analyzer.scala#L208-L212) so those `With`s will be removed in the end because we substitute `child` here: https://github.com/apache/spark/pull/28407/files#diff-d0bfa3367c63988ad7cf33397e643e75R91",
        "createdAt" : "2020-04-30T08:49:33Z",
        "updatedAt" : "2020-04-30T09:20:01Z",
        "lastEditedBy" : "3d4870da-39a8-4406-b00d-131930d14cd8",
        "tags" : [
        ]
      }
    ],
    "commit" : "b022e3513a842329b24569840a07a501bed9a188",
    "line" : 55,
    "diffHunk" : "@@ -1,1 +163,167 @@      }\n      // CTE definition can reference a previous one\n      resolvedCTERelations += (name -> substituteCTE(innerCTEResolved, resolvedCTERelations))\n    }\n    resolvedCTERelations"
  }
]