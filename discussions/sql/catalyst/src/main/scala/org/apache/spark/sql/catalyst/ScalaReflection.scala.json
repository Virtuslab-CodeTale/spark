[
  {
    "id" : "d7b4ac42-ebd7-427c-96c9-7f8d9a469c99",
    "prId" : 29403,
    "prUrl" : "https://github.com/apache/spark/pull/29403#pullrequestreview-498023439",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "9684790f-c8fd-42ae-9680-d7d8439f33b9",
        "parentId" : null,
        "authorId" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "body" : "Should also be `true`?",
        "createdAt" : "2020-09-28T15:35:34Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "tags" : [
        ]
      },
      {
        "id" : "8f4f69e4-46ec-4297-913e-4769582d3952",
        "parentId" : "9684790f-c8fd-42ae-9680-d7d8439f33b9",
        "authorId" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "body" : "Also, if I'm correct, it would be good to include a test case for this case.  What happens if you actually do operations on the null value stored as an enum?  Is the nullability of the resulting schema correct. Do operations like `.isNotNull` work correctly?",
        "createdAt" : "2020-09-29T02:26:25Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "tags" : [
        ]
      },
      {
        "id" : "47f3d0e4-f638-4320-acf4-133728a1d29f",
        "parentId" : "9684790f-c8fd-42ae-9680-d7d8439f33b9",
        "authorId" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "body" : "I think we need `returnNullable = false` since `Enumeration.withName` will never return null.",
        "createdAt" : "2020-09-29T02:28:03Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "tags" : [
        ]
      },
      {
        "id" : "fa14c12d-9cbf-48f8-922e-3a588e53bcf5",
        "parentId" : "9684790f-c8fd-42ae-9680-d7d8439f33b9",
        "authorId" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "body" : "Yeah, you are correct.",
        "createdAt" : "2020-09-29T02:34:49Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "tags" : [
        ]
      },
      {
        "id" : "74a0fc69-81af-428e-99ef-0e259d824e37",
        "parentId" : "9684790f-c8fd-42ae-9680-d7d8439f33b9",
        "authorId" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "body" : "> What happens if you actually do operations on the null value stored as an enum\r\n\r\nWe will get an exception, and the behavior is same as Java enum what we supported.\r\n```\r\n        case other if other.isEnum =>\r\n          createSerializerForString(\r\n            Invoke(inputObject, \"name\", ObjectType(classOf[String]), returnNullable = false))\r\n```",
        "createdAt" : "2020-09-29T02:35:48Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "tags" : [
        ]
      }
    ],
    "commit" : "2d675caa463dcbea5751b34c6463e7336a0fc76f",
    "line" : 28,
    "diffHunk" : "@@ -1,1 +395,399 @@          \"withName\",\n          createDeserializerForString(path, false) :: Nil,\n          returnNullable = false)\n    }\n  }"
  },
  {
    "id" : "e0f2df48-9ba3-4c3e-807b-84124b075b70",
    "prId" : 29403,
    "prUrl" : "https://github.com/apache/spark/pull/29403#pullrequestreview-498023176",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "7edf0ca7-5832-4425-852a-63cb328f6e86",
        "parentId" : null,
        "authorId" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "body" : "`true`?",
        "createdAt" : "2020-09-28T15:36:18Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "tags" : [
        ]
      },
      {
        "id" : "f073b20d-08f2-40d6-9b3a-f29d20af5555",
        "parentId" : "7edf0ca7-5832-4425-852a-63cb328f6e86",
        "authorId" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "body" : "Same as withName, toString also return a non-null value.",
        "createdAt" : "2020-09-29T02:28:59Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "tags" : [
        ]
      },
      {
        "id" : "e269a353-6b2e-493a-993c-3520490e58c3",
        "parentId" : "7edf0ca7-5832-4425-852a-63cb328f6e86",
        "authorId" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "body" : "Ah, I see. I agree.",
        "createdAt" : "2020-09-29T02:34:51Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "1d40bb30-68bd-4124-82bc-33d93ee4bc65",
        "tags" : [
        ]
      }
    ],
    "commit" : "2d675caa463dcbea5751b34c6463e7336a0fc76f",
    "line" : 42,
    "diffHunk" : "@@ -1,1 +587,591 @@            \"toString\",\n            ObjectType(classOf[java.lang.String]),\n            returnNullable = false))\n\n      case _ =>"
  },
  {
    "id" : "1bb46199-3bcc-4392-85fd-484321e7d2bf",
    "prId" : 29403,
    "prUrl" : "https://github.com/apache/spark/pull/29403#pullrequestreview-498309506",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "ce74ab9a-8e6f-43bd-8602-69e1d784009c",
        "parentId" : null,
        "authorId" : "9cd657f0-37cd-41bd-908a-f2c996b95a7a",
        "body" : "So we are returning the schema generated from enum as nullable, but the serializer expression is not nullable (because it does not produce null). Why is that?",
        "createdAt" : "2020-09-29T02:58:31Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "9cd657f0-37cd-41bd-908a-f2c996b95a7a",
        "tags" : [
        ]
      },
      {
        "id" : "9bd1bbc8-46a8-4897-843d-332520a44234",
        "parentId" : "ce74ab9a-8e6f-43bd-8602-69e1d784009c",
        "authorId" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "body" : "There are two side of `nullable`. \r\n* For schema, `nullable` means the column can be `null` value.\r\n* For `returnNullable` which used in `Invoke` and `StaticInvoke` means the method promise will never produce a `null` value.\r\n\r\nSome code get from `Invoke`\r\n```\r\ndef invoke(\r\n      obj: Any,\r\n      method: Method,\r\n      arguments: Seq[Expression],\r\n      input: InternalRow,\r\n      dataType: DataType): Any = {\r\n    val args = arguments.map(e => e.eval(input).asInstanceOf[Object])\r\n    if (needNullCheck && args.exists(_ == null)) {\r\n      // return null if one of arguments is null\r\n      null\r\n    } else {\r\n      val ret = method.invoke(obj, args: _*)\r\n      val boxedClass = ScalaReflection.typeBoxedJavaMapping.get(dataType)\r\n      if (boxedClass.isDefined) {\r\n        boxedClass.get.cast(ret)\r\n      } else {\r\n        ret\r\n      }\r\n    }\r\n  }\r\n```",
        "createdAt" : "2020-09-29T03:58:46Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "tags" : [
        ]
      },
      {
        "id" : "6dfaccb0-ddb9-41f3-aedd-c03052821ae9",
        "parentId" : "ce74ab9a-8e6f-43bd-8602-69e1d784009c",
        "authorId" : "9cd657f0-37cd-41bd-908a-f2c996b95a7a",
        "body" : "So effectively, in the serialized form, we are allowing nulls to be present in the column mapping to the enum field.  But if there is indeed a row with a null in that column and we attempt to deserialize that rows, then it will cause a runtime failure...isnt it?\r\n\r\nIf this understanding is correct, then serializing will never produce null, and even if there is a null, serializing will fail.  Then why keep this column nullable = true? I am not necessarily opposed to it, I am just trying to understand the rationale. cc @marmbrus ",
        "createdAt" : "2020-09-29T06:18:08Z",
        "updatedAt" : "2020-09-29T06:45:16Z",
        "lastEditedBy" : "9cd657f0-37cd-41bd-908a-f2c996b95a7a",
        "tags" : [
        ]
      },
      {
        "id" : "e8509733-3e05-43cb-9f57-90e86e9fee27",
        "parentId" : "ce74ab9a-8e6f-43bd-8602-69e1d784009c",
        "authorId" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "body" : "> But if there is indeed a row with a null in that column and we attempt to deserialize that rows, then it will cause a runtime failure...isnt it\r\n\r\nActually we will get null back. It's a trick that if input value is null the serializing will return null.",
        "createdAt" : "2020-09-29T10:03:05Z",
        "updatedAt" : "2020-09-29T10:03:05Z",
        "lastEditedBy" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "tags" : [
        ]
      }
    ],
    "commit" : "2d675caa463dcbea5751b34c6463e7336a0fc76f",
    "line" : 52,
    "diffHunk" : "@@ -1,1 +767,771 @@          }), nullable = true)\n      case t if isSubtype(t, localTypeOf[Enumeration#Value]) =>\n        Schema(StringType, nullable = true)\n      case other =>\n        throw new UnsupportedOperationException(s\"Schema for type $other is not supported\")"
  },
  {
    "id" : "97efe38b-d580-460f-8c56-be6c9f07edc1",
    "prId" : 29403,
    "prUrl" : "https://github.com/apache/spark/pull/29403#pullrequestreview-498307607",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "416228cd-402d-4179-acc0-21e881bb1dc3",
        "parentId" : null,
        "authorId" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "body" : "follow scala reflection.",
        "createdAt" : "2020-09-29T10:00:40Z",
        "updatedAt" : "2020-09-29T10:00:41Z",
        "lastEditedBy" : "baca2fab-b749-483f-8c77-c4db14eca9d9",
        "tags" : [
        ]
      }
    ],
    "commit" : "2d675caa463dcbea5751b34c6463e7336a0fc76f",
    "line" : 22,
    "diffHunk" : "@@ -1,1 +389,393 @@        // we can call example.Foo.withName to deserialize string to enumeration.\n        val parent = t.asInstanceOf[TypeRef].pre.typeSymbol.asClass\n        val cls = mirror.runtimeClass(parent)\n        StaticInvoke(\n          cls,"
  },
  {
    "id" : "c7de6a8a-eff9-4825-b3e2-96dfbfa5257b",
    "prId" : 28324,
    "prUrl" : "https://github.com/apache/spark/pull/28324#pullrequestreview-400023646",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "07876b26-ece5-4291-a23c-99e0ce5c15c5",
        "parentId" : null,
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "Thanks. It seems that these are matched with `dataTypeFor` now.",
        "createdAt" : "2020-04-24T14:58:03Z",
        "updatedAt" : "2020-04-24T16:42:23Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      }
    ],
    "commit" : "75fc96b6988316e5d1a27ae9ec8343a18b91ea6f",
    "line" : 6,
    "diffHunk" : "@@ -1,1 +129,133 @@      case t if isSubtype(t, localTypeOf[Array[Byte]]) => classOf[Array[Array[Byte]]]\n      case t if isSubtype(t, localTypeOf[CalendarInterval]) => classOf[Array[CalendarInterval]]\n      case t if isSubtype(t, localTypeOf[Decimal]) => classOf[Array[Decimal]]\n      case other =>\n        // There is probably a better way to do this, but I couldn't find it..."
  },
  {
    "id" : "821ba369-c5ba-432d-a848-b200a810f54f",
    "prId" : 28324,
    "prUrl" : "https://github.com/apache/spark/pull/28324#pullrequestreview-400445340",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "ccf53c07-5691-4e7e-937a-c085bdf49d6c",
        "parentId" : null,
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "nit: might be worth updating the comment above: https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/ScalaReflection.scala#L117-L118",
        "createdAt" : "2020-04-26T01:00:52Z",
        "updatedAt" : "2020-04-26T01:00:52Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      }
    ],
    "commit" : "75fc96b6988316e5d1a27ae9ec8343a18b91ea6f",
    "line" : 4,
    "diffHunk" : "@@ -1,1 +127,131 @@      case t if isSubtype(t, definitions.ByteTpe) => classOf[Array[Byte]]\n      case t if isSubtype(t, definitions.BooleanTpe) => classOf[Array[Boolean]]\n      case t if isSubtype(t, localTypeOf[Array[Byte]]) => classOf[Array[Array[Byte]]]\n      case t if isSubtype(t, localTypeOf[CalendarInterval]) => classOf[Array[CalendarInterval]]\n      case t if isSubtype(t, localTypeOf[Decimal]) => classOf[Array[Decimal]]"
  }
]