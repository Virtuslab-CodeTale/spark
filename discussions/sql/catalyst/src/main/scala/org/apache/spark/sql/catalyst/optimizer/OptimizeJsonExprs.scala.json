[
  {
    "id" : "d8e3a201-b279-4278-8529-5d17bba3eb49",
    "prId" : 30921,
    "prUrl" : "https://github.com/apache/spark/pull/30921#pullrequestreview-558719329",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "8235296a-babe-4772-b278-bff99231eb3c",
        "parentId" : null,
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "Ur, you should not use `[TEST]` tag when you touch `src/main`.",
        "createdAt" : "2020-12-24T21:27:03Z",
        "updatedAt" : "2020-12-24T21:27:03Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      },
      {
        "id" : "2ce32a7b-2ed5-4707-800b-bfd04101a68a",
        "parentId" : "8235296a-babe-4772-b278-bff99231eb3c",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "Removed.",
        "createdAt" : "2020-12-24T22:03:45Z",
        "updatedAt" : "2020-12-24T22:03:46Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "63887f5f099ddf3ff790ba877849ec344ad7b2e8",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +83,87 @@\n      case g @ GetStructField(j @ JsonToStructs(schema: StructType, _, _, _), ordinal, _)\n          if schema.length > 1 && j.options.isEmpty =>\n        val prunedSchema = StructType(Seq(schema(ordinal)))\n        g.copy(child = j.copy(schema = prunedSchema), ordinal = 0)"
  },
  {
    "id" : "36d28984-c0ec-4769-aad1-ab98f764ce2c",
    "prId" : 29942,
    "prUrl" : "https://github.com/apache/spark/pull/29942#pullrequestreview-501739196",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f4cb1e14-e1be-4224-9a18-cde8b1a14f73",
        "parentId" : null,
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "Is this related to this optimization? This looks more general to me.",
        "createdAt" : "2020-10-05T01:05:10Z",
        "updatedAt" : "2020-10-06T23:25:15Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "79e0fc38-ac84-4a31-bc51-5282a735728e",
        "parentId" : "f4cb1e14-e1be-4224-9a18-cde8b1a14f73",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "`JsonToStructs`'s `nullable` is true. If the input json to `JsonToStructs` is null, we will get a null output. But `CreateNamedStruct`'s `nullable` is false, so here we need to keep nullability unchanged by wrapping them with a `If(IsNull...)`.",
        "createdAt" : "2020-10-05T05:44:37Z",
        "updatedAt" : "2020-10-06T23:25:15Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "b62c3b38-2c12-448a-96b0-8f33cc876de1",
        "parentId" : "f4cb1e14-e1be-4224-9a18-cde8b1a14f73",
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "Ah, ok. I see.",
        "createdAt" : "2020-10-05T05:58:49Z",
        "updatedAt" : "2020-10-06T23:25:15Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      }
    ],
    "commit" : "73320e89f512b896ceee9eebe283046db3dda15a",
    "line" : 39,
    "diffHunk" : "@@ -1,1 +64,68 @@          }.toSeq\n\n          If(IsNull(fromJson.child), c.copy(children = nullFields), KnownNotNull(fromJson))\n        } else {\n          c"
  },
  {
    "id" : "46972a4a-93eb-4552-8ed1-3c57201bb8e5",
    "prId" : 29942,
    "prUrl" : "https://github.com/apache/spark/pull/29942#pullrequestreview-501738688",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "87773e85-e22a-4632-9250-a5da81343b25",
        "parentId" : null,
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "Does this work correctly if multiple values refer to the same ordinal?\r\n```\r\nscala> sql(\"\"\"SELECT from_json('{\"a\":1, \"b\":0.8}', 'a INT, b DOUBLE') v\"\"\").createOrReplaceTempView(\"t\")\r\nscala> sql(\"select named_struct('a', t.v.a, 'a', t.v.a) from t\").explain(true)\r\n== Parsed Logical Plan ==\r\n'Project [unresolvedalias('named_struct(a, 't.v.a, a, 't.v.a), None)]\r\n+- 'UnresolvedRelation [t], [], false\r\n\r\n== Analyzed Logical Plan ==\r\nnamed_struct(a, v.a AS `a`, a, v.a AS `a`): struct<a:int,a:int>\r\nProject [named_struct(a, v#128.a, a, v#128.a) AS named_struct(a, v.a AS `a`, a, v.a AS `a`)#133]\r\n+- SubqueryAlias t\r\n   +- Project [from_json(StructField(a,IntegerType,true), StructField(b,DoubleType,true), {\"a\":1, \"b\":0.8}, Some(Asia/Tokyo)) AS v#128]\r\n      +- OneRowRelation\r\n\r\n== Optimized Logical Plan ==\r\nProject [[1,1] AS named_struct(a, v.a AS `a`, a, v.a AS `a`)#133]\r\n+- OneRowRelation\r\n\r\n== Physical Plan ==\r\n*(1) Project [[1,1] AS named_struct(a, v.a AS `a`, a, v.a AS `a`)#133]\r\n+- *(1) Scan OneRowRelation[]\r\n```",
        "createdAt" : "2020-10-05T01:20:16Z",
        "updatedAt" : "2020-10-06T23:25:15Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "1c5f28df-0b4c-4719-a68e-b781bae49b52",
        "parentId" : "87773e85-e22a-4632-9250-a5da81343b25",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "Oh, this is kind of corner case. We cannot simplify this case. Added test case.",
        "createdAt" : "2020-10-05T05:57:20Z",
        "updatedAt" : "2020-10-06T23:25:15Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "73320e89f512b896ceee9eebe283046db3dda15a",
    "line" : 23,
    "diffHunk" : "@@ -1,1 +48,52 @@        val sameFieldName = c.names.zip(c.valExprs).forall {\n          case (name, valExpr: GetStructField) =>\n            name.toString == valExpr.childSchema(valExpr.ordinal).name\n          case _ => false\n        }"
  },
  {
    "id" : "0dde03c2-e42a-4d46-96a1-cc1a922a3161",
    "prId" : 29942,
    "prUrl" : "https://github.com/apache/spark/pull/29942#pullrequestreview-503405565",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "ceba0ae6-0696-474c-bf5b-259860e86673",
        "parentId" : null,
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "~`c.names.map(_.toString).distinct.length` seems to ignore case-insensitive situation. Could you add a test case for column `A` and `a` in case-insensitive mode? If we don't need to consider that case because this is `Json`, could you add more explanation about that, please?~ Never mind. I misread it.",
        "createdAt" : "2020-10-06T22:32:25Z",
        "updatedAt" : "2020-10-06T23:25:15Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      }
    ],
    "commit" : "73320e89f512b896ceee9eebe283046db3dda15a",
    "line" : 29,
    "diffHunk" : "@@ -1,1 +54,58 @@        // Although `CreateNamedStruct` allows duplicated field names, e.g. \"a int, a int\",\n        // `JsonToStructs` does not support parsing json with duplicated field names.\n        val duplicateFields = c.names.map(_.toString).distinct.length != c.names.length\n\n        // If we create struct from various fields of the same `JsonToStructs` and we don't"
  },
  {
    "id" : "70d58a57-1e7e-444f-af92-cf10eacdb857",
    "prId" : 29942,
    "prUrl" : "https://github.com/apache/spark/pull/29942#pullrequestreview-503426537",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "c91b5674-7d11-407b-80e0-2e424e597f8e",
        "parentId" : null,
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "@viirya . It would be great if we describe `If(IsNull(json),  nullStruct, KnownNotNull(JsonToStructs(prunedSchema1, options, json, ..))` pattern here because technically it's a new optimized form but not a simplified one. The existing (1), (2), (3) of this AS-IS PR doesn't cover it.",
        "createdAt" : "2020-10-06T23:04:29Z",
        "updatedAt" : "2020-10-06T23:25:15Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      },
      {
        "id" : "8bae80e1-ec41-4774-a910-aefadf651ec5",
        "parentId" : "c91b5674-7d11-407b-80e0-2e424e597f8e",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "Ok, revised the comment here. Thanks.",
        "createdAt" : "2020-10-06T23:25:19Z",
        "updatedAt" : "2020-10-06T23:25:19Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "73320e89f512b896ceee9eebe283046db3dda15a",
    "line" : 3,
    "diffHunk" : "@@ -1,1 +28,32 @@ * The optimization includes:\n * 1. JsonToStructs(StructsToJson(child)) => child.\n * 2. Prune unnecessary columns from GetStructField/GetArrayStructFields + JsonToStructs.\n * 3. CreateNamedStruct(JsonToStructs(json).col1, JsonToStructs(json).col2, ...) =>\n *      If(IsNull(json), nullStruct, KnownNotNull(JsonToStructs(prunedSchema, ..., json)))"
  },
  {
    "id" : "e1f57f80-bf0d-44e5-88e6-dca96b73183c",
    "prId" : 29828,
    "prUrl" : "https://github.com/apache/spark/pull/29828#pullrequestreview-493628886",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "762d49f2-21ef-46ea-99c0-484bf068b08f",
        "parentId" : null,
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "shall we optimize csv in this rule as well?",
        "createdAt" : "2020-09-22T11:54:28Z",
        "updatedAt" : "2020-09-29T05:05:27Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      },
      {
        "id" : "5ec480d5-c3ad-4178-bb65-f9f3ff3fe408",
        "parentId" : "762d49f2-21ef-46ea-99c0-484bf068b08f",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "Yes, I think so. We could do it in other PR.",
        "createdAt" : "2020-09-22T16:11:42Z",
        "updatedAt" : "2020-09-29T05:05:27Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "dde0126ea86e1079ead6e38189720feb5b680ea2",
    "line" : 27,
    "diffHunk" : "@@ -1,1 +25,29 @@ * Simplify redundant json related expressions.\n */\nobject OptimizeJsonExprs extends Rule[LogicalPlan] {\n  override def apply(plan: LogicalPlan): LogicalPlan = plan transform {\n    case p => p.transformExpressions {"
  },
  {
    "id" : "9ed5db21-4004-4376-a08e-507046b0c016",
    "prId" : 29828,
    "prUrl" : "https://github.com/apache/spark/pull/29828#pullrequestreview-493992585",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "c7a2b5ae-df9d-4fc6-89b4-017b7b2ac2e4",
        "parentId" : null,
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "nit: `OptimizeJsonExprs` -> `RemoveRedundantJsonExprs`?",
        "createdAt" : "2020-09-23T01:43:57Z",
        "updatedAt" : "2020-09-29T05:05:27Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "c8e0b356-6cee-4c26-b19b-f522634f270f",
        "parentId" : "c7a2b5ae-df9d-4fc6-89b4-017b7b2ac2e4",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "I will work on column pruning of to_from later. It will be in this rule too.",
        "createdAt" : "2020-09-23T01:52:33Z",
        "updatedAt" : "2020-09-29T05:05:27Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      },
      {
        "id" : "e4e9a1d2-7c4b-4508-aa39-3008d8c513b7",
        "parentId" : "c7a2b5ae-df9d-4fc6-89b4-017b7b2ac2e4",
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "Ah, I see.",
        "createdAt" : "2020-09-23T01:54:45Z",
        "updatedAt" : "2020-09-29T05:05:27Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "93f43b01-dcad-45b2-9540-83c71443c558",
        "parentId" : "c7a2b5ae-df9d-4fc6-89b4-017b7b2ac2e4",
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "Just a comment; probably, its better to list up what this rule optimizes in the comment. It is okay to do it in your next PR though.",
        "createdAt" : "2020-09-23T02:02:28Z",
        "updatedAt" : "2020-09-29T05:05:27Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "39982127-51a3-4511-8e80-85ce684ecd58",
        "parentId" : "c7a2b5ae-df9d-4fc6-89b4-017b7b2ac2e4",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "sure. will do later when adding other optimization.",
        "createdAt" : "2020-09-23T02:48:23Z",
        "updatedAt" : "2020-09-29T05:05:27Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "dde0126ea86e1079ead6e38189720feb5b680ea2",
    "line" : 25,
    "diffHunk" : "@@ -1,1 +23,27 @@\n/**\n * Simplify redundant json related expressions.\n */\nobject OptimizeJsonExprs extends Rule[LogicalPlan] {"
  },
  {
    "id" : "312b88f2-983f-4390-9afe-7e818baffba1",
    "prId" : 29828,
    "prUrl" : "https://github.com/apache/spark/pull/29828#pullrequestreview-495785845",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "06c1dddb-d41b-4aa6-978f-7441f6ff19d2",
        "parentId" : null,
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "Yes, this `options1.isEmpty && options2.isEmpty` looks better.",
        "createdAt" : "2020-09-24T16:17:30Z",
        "updatedAt" : "2020-09-29T05:05:27Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      },
      {
        "id" : "59921a83-3b15-4274-9619-6a3bbf15145c",
        "parentId" : "06c1dddb-d41b-4aa6-978f-7441f6ff19d2",
        "authorId" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "body" : "thanks.",
        "createdAt" : "2020-09-24T17:15:45Z",
        "updatedAt" : "2020-09-29T05:05:27Z",
        "lastEditedBy" : "5e28de51-305c-4276-b3a0-78bcc74eb6f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "dde0126ea86e1079ead6e38189720feb5b680ea2",
    "line" : 32,
    "diffHunk" : "@@ -1,1 +30,34 @@      case jsonToStructs @ JsonToStructs(_, options1,\n        StructsToJson(options2, child, timeZoneId2), timeZoneId1)\n          if options1.isEmpty && options2.isEmpty && timeZoneId1 == timeZoneId2 &&\n            jsonToStructs.dataType == child.dataType =>\n        // `StructsToJson` only fails when `JacksonGenerator` encounters data types it"
  }
]