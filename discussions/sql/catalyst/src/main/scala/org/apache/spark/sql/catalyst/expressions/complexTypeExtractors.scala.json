[
  {
    "id" : "b3e5ddf2-5e60-41fd-b248-389a9845fb74",
    "prId" : 31808,
    "prUrl" : "https://github.com/apache/spark/pull/31808#pullrequestreview-609499640",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "fd1debdd-ab17-4157-b159-4765ffa4e0a3",
        "parentId" : null,
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "Oh, do we have a valid case for this?",
        "createdAt" : "2021-03-11T08:04:37Z",
        "updatedAt" : "2021-03-11T08:04:38Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      },
      {
        "id" : "7b255e48-1f2a-4871-a53a-8f4e06228cab",
        "parentId" : "fd1debdd-ab17-4157-b159-4765ffa4e0a3",
        "authorId" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "body" : "e.g. `col[1]` to get the map value. It's not a single `UnresolvedAttribute` (multi-part name like `a.b.c`) and is unrelated to this bug fix",
        "createdAt" : "2021-03-11T08:29:40Z",
        "updatedAt" : "2021-03-11T08:29:41Z",
        "lastEditedBy" : "b1f2cebb-db23-4759-b446-886279d07e99",
        "tags" : [
        ]
      }
    ],
    "commit" : "a35e700696f44698e8b945f99a14f04fa266e0ab",
    "line" : 34,
    "diffHunk" : "@@ -1,1 +456,460 @@  override def name: Option[String] = key match {\n    case NonNullLiteral(s, StringType) => Some(s.toString)\n    case _ => None\n  }\n"
  },
  {
    "id" : "e3e3467c-0165-498e-93fd-bced11bb3c19",
    "prId" : 30560,
    "prUrl" : "https://github.com/apache/spark/pull/30560#pullrequestreview-542201234",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "54ca3005-6a58-4c77-b59a-a4cafa329bc3",
        "parentId" : null,
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "@leanken, can we add a test?",
        "createdAt" : "2020-12-01T10:06:16Z",
        "updatedAt" : "2020-12-02T10:15:30Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      },
      {
        "id" : "f0b9d1dc-8d12-471f-9f4a-e62264fe7b09",
        "parentId" : "54ca3005-6a58-4c77-b59a-a4cafa329bc3",
        "authorId" : "cce1c782-0596-44b6-8b99-6b77d2cca53c",
        "body" : "> @leanken, can we add a test?\r\n\r\nCurrently, this case being missed in SPARK-33460 it is because checkExceptionInExpression is not as expected. And as i investigated, there are some cases would fail if I correct the behavior of checkExceptionInExpression by using withSQLConf set CodeGenFallBack to false, like ObjectExpressionsSuite and RegexpExpressionsSuite and etc.\r\n\r\n![image](https://user-images.githubusercontent.com/17242071/100730052-82913500-3404-11eb-8b77-73c6776417a8.png)\r\n\r\n\r\nSo I need your advise. Should I\r\n1. Fix all these wrong behavior separately and then finally fix checkExceptionInExpression.\r\n2. Fix all these wrong behavior and checkExceptionInExpression with the same patch.\r\n\r\nThe reason why i submit this PR it's because this bug introduced by me and I know of the history, but all those other behavior is fresh to me, and the all-in-one fix might be big.\r\n\r\nAs for add a test to the java.util.NoSuchElementException, I think the offline manual verification is enough, If we fix checkExceptionInExpression, and make it reliable, then we don't need to check code gen behavior for every new added or updated operation, right?\r\n",
        "createdAt" : "2020-12-01T10:37:42Z",
        "updatedAt" : "2020-12-02T10:15:30Z",
        "lastEditedBy" : "cce1c782-0596-44b6-8b99-6b77d2cca53c",
        "tags" : [
        ]
      },
      {
        "id" : "af0d9ccb-d490-4d2b-bab1-23a1edb3719a",
        "parentId" : "54ca3005-6a58-4c77-b59a-a4cafa329bc3",
        "authorId" : "cce1c782-0596-44b6-8b99-6b77d2cca53c",
        "body" : "> @leanken, can we add a test?\r\n\r\nmaybe you can try reproduce ObjectExpressionsSuite and RegexpExpressionsSuite in your environment so that you can get clearer picture.",
        "createdAt" : "2020-12-01T10:40:38Z",
        "updatedAt" : "2020-12-02T10:15:30Z",
        "lastEditedBy" : "cce1c782-0596-44b6-8b99-6b77d2cca53c",
        "tags" : [
        ]
      },
      {
        "id" : "a8ce26f3-d2aa-4972-9622-d95b2e900211",
        "parentId" : "54ca3005-6a58-4c77-b59a-a4cafa329bc3",
        "authorId" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "body" : "> And as i investigated, there are some cases would fail if I correct the behavior of checkExceptionInExpression by using withSQLConf set CodeGenFallBack to false, like ObjectExpressionsSuite and RegexpExpressionsSuite and etc.\r\n\r\nHow about making a PR to fix `checkExceptionInExpression` first? I'm currently not sure how many failures caused by it exist. If there are too many failures, we can separate the work to fix them then.",
        "createdAt" : "2020-12-01T14:22:25Z",
        "updatedAt" : "2020-12-02T10:15:30Z",
        "lastEditedBy" : "044062b3-9d96-4ec3-a1e2-3a2f595bbc02",
        "tags" : [
        ]
      },
      {
        "id" : "ce268e3b-469c-460c-940c-5ab3562b67ca",
        "parentId" : "54ca3005-6a58-4c77-b59a-a4cafa329bc3",
        "authorId" : "7694af3d-5af2-4788-8413-c0558915c452",
        "body" : "+1 for @maropu 's advice.",
        "createdAt" : "2020-12-01T18:54:36Z",
        "updatedAt" : "2020-12-02T10:15:30Z",
        "lastEditedBy" : "7694af3d-5af2-4788-8413-c0558915c452",
        "tags" : [
        ]
      }
    ],
    "commit" : "95bdd379d7addcac25de3e52dd27710f04bec988",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +395,399 @@    nullSafeCodeGen(ctx, ev, (eval1, eval2) => {\n      val keyNotFoundBranch = if (failOnError) {\n        s\"\"\"throw new java.util.NoSuchElementException(\"Key \" + $eval2 + \" does not exist.\");\"\"\"\n      } else {\n        s\"${ev.isNull} = true;\""
  },
  {
    "id" : "b9dc946d-4a44-42a5-9c5d-b3e00b02ad7b",
    "prId" : 28860,
    "prUrl" : "https://github.com/apache/spark/pull/28860#pullrequestreview-438195291",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "33eb3ca4-6dae-4112-9767-3fa4578d9e6e",
        "parentId" : null,
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "nit:\r\n\r\n```\r\ncase (ExtractNestedArray(\r\n    StructType(fields), containsNull, containsNullSeq), NonNullLiteral(v, StringType)) =>\r\n```\r\n",
        "createdAt" : "2020-06-26T10:41:25Z",
        "updatedAt" : "2020-06-26T10:41:25Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      },
      {
        "id" : "ee7ff58c-a1ad-404b-8547-0e482ea5bf80",
        "parentId" : "33eb3ca4-6dae-4112-9767-3fa4578d9e6e",
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "Let's also update the documentation and table above.",
        "createdAt" : "2020-06-26T10:43:40Z",
        "updatedAt" : "2020-06-26T10:43:40Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      }
    ],
    "commit" : "b6e92c025a4f3746165a3ba660fe80cca63bb91f",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +61,65 @@\n      case (ExtractNestedArray(StructType(fields), containsNull, containsNullSeq),\n      NonNullLiteral(v, StringType)) =>\n       child match {\n          case ExtractGetArrayStructField(_, num) if num == containsNullSeq.size =>"
  },
  {
    "id" : "37296782-f0e8-43b3-a7c6-5855f477250b",
    "prId" : 28860,
    "prUrl" : "https://github.com/apache/spark/pull/28860#pullrequestreview-438195773",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f3f56ca0-ef74-4274-8008-7eb9aa9532f3",
        "parentId" : null,
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "Let's add documentation here.",
        "createdAt" : "2020-06-26T10:44:37Z",
        "updatedAt" : "2020-06-26T10:44:37Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      }
    ],
    "commit" : "b6e92c025a4f3746165a3ba660fe80cca63bb91f",
    "line" : 28,
    "diffHunk" : "@@ -1,1 +113,117 @@trait ExtractValue extends Expression\n\nobject ExtractNestedArray {\n\n  type ReturnType = Option[(DataType, Boolean, Seq[Boolean])]"
  },
  {
    "id" : "da897f0e-8c58-44dc-bda1-503b85ab079c",
    "prId" : 28860,
    "prUrl" : "https://github.com/apache/spark/pull/28860#pullrequestreview-438195903",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "23166aa9-0a26-4bd7-9e06-08d503fce56a",
        "parentId" : null,
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "Let's also add some comments for what this type means.",
        "createdAt" : "2020-06-26T10:44:53Z",
        "updatedAt" : "2020-06-26T10:44:53Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      }
    ],
    "commit" : "b6e92c025a4f3746165a3ba660fe80cca63bb91f",
    "line" : 30,
    "diffHunk" : "@@ -1,1 +115,119 @@object ExtractNestedArray {\n\n  type ReturnType = Option[(DataType, Boolean, Seq[Boolean])]\n\n  def unapply(dataType: DataType): ReturnType = {"
  },
  {
    "id" : "3282cb7d-689b-4828-acb9-f62900c4029e",
    "prId" : 28860,
    "prUrl" : "https://github.com/apache/spark/pull/28860#pullrequestreview-438196594",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "10421872-05de-4620-827a-2cf9d82f7e60",
        "parentId" : null,
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "Let's avoid arguments matching. This is actually an anti pattern - https://github.com/databricks/scala-style-guide#pattern-matching",
        "createdAt" : "2020-06-26T10:46:13Z",
        "updatedAt" : "2020-06-26T10:46:13Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      }
    ],
    "commit" : "b6e92c025a4f3746165a3ba660fe80cca63bb91f",
    "line" : 61,
    "diffHunk" : "@@ -1,1 +146,150 @@  def extractArrayStruct(expr: Expression): ReturnType = {\n    expr match {\n      case gas @ GetArrayStructFields(child, _, _, _, _) =>\n        extractArrayStruct(child) match {\n          case Some((e, deep)) => Some(e, deep + 1)"
  },
  {
    "id" : "5e6958be-8fae-41f4-9ce1-c69d067497f2",
    "prId" : 28860,
    "prUrl" : "https://github.com/apache/spark/pull/28860#pullrequestreview-438197232",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "25aee400-324a-457d-87ac-bd20e48270ec",
        "parentId" : null,
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "`deep` -> `depth`?",
        "createdAt" : "2020-06-26T10:47:25Z",
        "updatedAt" : "2020-06-26T10:47:26Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      }
    ],
    "commit" : "b6e92c025a4f3746165a3ba660fe80cca63bb91f",
    "line" : 63,
    "diffHunk" : "@@ -1,1 +148,152 @@      case gas @ GetArrayStructFields(child, _, _, _, _) =>\n        extractArrayStruct(child) match {\n          case Some((e, deep)) => Some(e, deep + 1)\n          case None => Some(child, 1)\n        }"
  },
  {
    "id" : "afc14a11-bb4a-480f-9330-769c8daf6082",
    "prId" : 28860,
    "prUrl" : "https://github.com/apache/spark/pull/28860#pullrequestreview-438198820",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "04a7a4d7-a498-401f-a76a-ab5e267447f6",
        "parentId" : null,
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "Can we combine this and `unapply`?",
        "createdAt" : "2020-06-26T10:50:25Z",
        "updatedAt" : "2020-06-26T10:50:25Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      }
    ],
    "commit" : "b6e92c025a4f3746165a3ba660fe80cca63bb91f",
    "line" : 36,
    "diffHunk" : "@@ -1,1 +121,125 @@  }\n\n  def extractArrayType(dataType: DataType): ReturnType = {\n    dataType match {\n      case ArrayType(dt, containsNull) =>"
  },
  {
    "id" : "9ace56a9-ecd4-479c-8617-e10db09d63ba",
    "prId" : 28860,
    "prUrl" : "https://github.com/apache/spark/pull/28860#pullrequestreview-438202668",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "fa85b609-113d-4835-bb48-b44d7a8da231",
        "parentId" : null,
        "authorId" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "body" : "Let's also name it something like `ExtractNestedArrayType`",
        "createdAt" : "2020-06-26T10:57:42Z",
        "updatedAt" : "2020-06-26T10:57:55Z",
        "lastEditedBy" : "5e07d5ab-b4b3-41e4-beca-fefd635980c6",
        "tags" : [
        ]
      }
    ],
    "commit" : "b6e92c025a4f3746165a3ba660fe80cca63bb91f",
    "line" : 28,
    "diffHunk" : "@@ -1,1 +113,117 @@trait ExtractValue extends Expression\n\nobject ExtractNestedArray {\n\n  type ReturnType = Option[(DataType, Boolean, Seq[Boolean])]"
  }
]